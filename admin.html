<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>Doktor Ba≈üvurularƒ± - Clinifly Admin (FIXED v20260209)</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("admin_token");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase
    const supabase = supabase.createClient(
      'https://your-project.supabase.co',
      'your-anon-key'
    );
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root {
      --bg:#111827;
      --card:#1f2937;
      --b:#374151;
      --p:#2563eb;
      --g:#16a34a;
      --r:#dc2626;
      --y:#f59e0b;
      --muted:#a7b2c8;
      --link:#6aa6ff;
    }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#e6eaf2; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    header{ margin-bottom:20px; border-bottom:1px solid var(--b); padding-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px; }
    h1{ font-size:24px; margin:0 0 20px; font-weight:700; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--b);
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 20px;
      color: #fff;
    }
    .navbar-links {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .navbar-link {
      color: var(--muted);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .navbar-link:hover {
      background: var(--card);
      color: #fff;
    }
    .navbar-link.active {
      background: var(--p);
      color: #fff;
    }

    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:24px; }
    .stat-card{ background:var(--card); border:1px solid var(--b); border-radius:12px; padding:20px; text-align:center; }
    .stat-number{ font-size:32px; font-weight:700; color:#fff; margin-bottom:4px; }
    .stat-label{ color:var(--muted); font-size:14px; }

    .search-filter{ display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
    .search-input{ flex:1; min-width:200px; background:var(--card); border:1px solid var(--b); color:#fff; padding:12px 16px; border-radius:8px; font-size:14px; }
    .search-input::placeholder{ color:var(--muted); }
    .filter-btn{ background:var(--card); border:1px solid var(--b); color:var(--muted); padding:12px 20px; border-radius:8px; font-size:14px; cursor:pointer; transition:all 0.2s; }
    .filter-btn:hover{ background:var(--b); color:#fff; }
    .filter-btn.active{ background:var(--p); color:#fff; border-color:var(--p); }

    .doctor-grid{ display:grid; gap:16px; }
    .doctor-card{ background:var(--card); border:1px solid var(--b); border-radius:12px; padding:20px; display:flex; justify-content:space-between; align-items:center; transition:all 0.2s; }
    .doctor-card:hover{ border-color:var(--p); transform:translateY(-1px); }
    .doctor-info{ flex:1; }
    .doctor-name{ font-size:18px; font-weight:600; color:#fff; margin-bottom:8px; }
    .doctor-details{ color:var(--muted); font-size:14px; line-height:1.5; }
    .doctor-details span{ display:block; margin-bottom:2px; }
    .doctor-meta{ display:flex; align-items:center; gap:8px; margin-top:8px; }
    .status-badge{ padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; text-transform:uppercase; }
    .status-pending{ background:var(--y); color:#000; }
    .status-approved{ background:var(--g); color:#fff; }
    .status-rejected{ background:var(--r); color:#fff; }
    .role-badge{ background:var(--p); color:#fff; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600; }
    .doctor-actions{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .btn{ padding:8px 16px; border-radius:6px; font-size:14px; font-weight:600; text-decoration:none; text-align:center; cursor:pointer; transition:all 0.2s; border:none; }
    .btn-primary{ background:var(--p); color:#fff; }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-success{ background:var(--g); color:#fff; }
    .btn-success:hover{ background:#15803d; }
    .btn-danger{ background:var(--r); color:#fff; }
    .btn-danger:hover{ background:#b91c1c; }
    .btn-secondary{ background:var(--card); color:var(--muted); border:1px solid var(--b); }
    .btn-secondary:hover{ background:var(--b); color:#fff; }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .empty-state{ text-align:center; padding:60px 20px; color:var(--muted); }
    .empty-icon{ font-size:48px; margin-bottom:16px; opacity:0.5; }
    .loading{ text-align:center; padding:40px; color:var(--muted); }
    .error{ background:#3a1620; border:1px solid #5a2232; color:#ffd7df; padding:16px; border-radius:8px; margin-bottom:20px; }

    @media (max-width:768px){
      .wrap{ padding:12px; }
      .doctor-card{ flex-direction:column; align-items:flex-start; gap:16px; }
      .doctor-actions{ width:100%; flex-direction:row; justify-content:flex-end; }
      .navbar{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="navbar">
        <div class="navbar-left">
          <div class="navbar-logo">
            üè• Clinifly Admin
          </div>
        </div>
        <div class="navbar-links">
        <a href="#doctors" class="navbar-link active" onclick="showSection('doctors')">Doktorlar</a>
        <a href="#treatment-groups" class="navbar-link" onclick="showSection('treatment-groups')">ü¶∑ Tedavi Gruplarƒ±</a>
        <a href="#patients" class="navbar-link" onclick="showSection('patients')">üë• Hastalar</a>
      </div>
      </div>
      <h1>üë®‚Äç‚öïÔ∏è Doktor Ba≈üvurularƒ±</h1>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="pending-count">-</div>
        <div class="stat-label">Bekleyen Ba≈üvuru</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="approved-count">-</div>
        <div class="stat-label">Onaylanan Doktor</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="rejected-count">-</div>
        <div class="stat-label">Reddedilen Ba≈üvuru</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-count">-</div>
        <div class="stat-label">Toplam Ba≈üvuru</div>
      </div>
    </div>

    <div class="search-filter">
      <input type="text" class="search-input" id="search-input" placeholder="Doktor adƒ±, email veya telefon ile ara...">
      <select class="filter-btn" id="status-filter">
        <option value="">T√ºm Durumlar</option>
        <option value="PENDING">Bekleyen</option>
        <option value="ACTIVE">Onaylanan</option>
        <option value="REJECTED">Reddedilen</option>
      </select>
      <button class="filter-btn" onclick="loadApplications()">üîÑ Yenile</button>
    </div>

    <div id="error-container"></div>
    <div id="loading-container" class="loading" style="display:none;">
      <div>üîÑ Y√ºkleniyor...</div>
    </div>
    <div id="doctors-container" class="doctor-grid"></div>
    <div id="empty-container" class="empty-state" style="display:none;">
      <div class="empty-icon">üìã</div>
      <div>Hen√ºz doktor ba≈üvurusu bulunmuyor</div>
    </div>

    <!-- Treatment Groups Section -->
    <div id="treatment-groups-container" style="display:none;">
      <div class="section-header">
        <h2>ü¶∑ Tedavi Gruplarƒ±</h2>
        <button class="btn btn-primary" onclick="showCreateGroupModal()">+ Yeni Grup Olu≈ütur</button>
      </div>

      <div class="groups-grid" id="groups-grid"></div>
      <div id="groups-empty" class="empty-state" style="display:none;">
        <div class="empty-icon">ü¶∑</div>
        <div>Hen√ºz tedavi grubu bulunmuyor</div>
      </div>
    </div>

    <!-- Patients Section -->
    <div id="patients-container" style="display:none;">
      <div class="section-header">
        <h2>üë• Hastalar</h2>
        <button class="btn btn-primary" onclick="showAssignPatientModal()">+ Hasta Ata</button>
      </div>

      <div class="patients-grid" id="patients-grid"></div>
      <div id="patients-empty" class="empty-state" style="display:none;">
        <div class="empty-icon">üë•</div>
        <div>Hen√ºz hasta bulunmuyor</div>
      </div>
    </div>
  </div>

  <script>
    let allDoctors = [];
    let filteredDoctors = [];

    async function loadApplications() {
      const token = localStorage.getItem("admin_token");
      const loadingContainer = document.getElementById("loading-container");
      const errorContainer = document.getElementById("error-container");
      const doctorsContainer = document.getElementById("doctors-container");
      const emptyContainer = document.getElementById("empty-container");

      loadingContainer.style.display = "block";
      errorContainer.innerHTML = "";
      doctorsContainer.innerHTML = "";
      emptyContainer.style.display = "none";

      try {
        const response = await fetch("/api/admin/doctor-applications", {
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.ok) {
          allDoctors = data.doctors || [];
          filteredDoctors = [...allDoctors];
          updateStats();
          renderDoctors();
        } else {
          throw new Error(data.error || "Ba≈üvurular y√ºklenemedi");
        }
      } catch (error) {
        console.error("Load applications error:", error);
        errorContainer.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
      } finally {
        loadingContainer.style.display = "none";
      }
    }

    function updateStats() {
      const pending = allDoctors.filter(d => d.status === "PENDING").length;
      const approved = allDoctors.filter(d => d.status === "ACTIVE").length;
      const rejected = allDoctors.filter(d => d.status === "REJECTED").length;
      const total = allDoctors.length;

      document.getElementById("pending-count").textContent = pending;
      document.getElementById("approved-count").textContent = approved;
      document.getElementById("rejected-count").textContent = rejected;
      document.getElementById("total-count").textContent = total;
    }

    function renderDoctors() {
      const container = document.getElementById("doctors-container");
      const emptyContainer = document.getElementById("empty-container");
      
      if (filteredDoctors.length === 0) {
        container.style.display = "none";
        emptyContainer.style.display = "flex";
      } else {
        container.style.display = "grid";
        emptyContainer.style.display = "none";
        
        container.innerHTML = filteredDoctors.map(doctor => `
          <div class="doctor-card" data-id="${doctor.doctor_id}">
            <div class="doctor-header">
              <div class="doctor-info">
                <div class="doctor-name">${doctor.name}</div>
                <div class="doctor-details">
                  <span>üì± ${doctor.phone}</span>
                  ${doctor.email ? `<span>üìß ${doctor.email}</span>` : ""}
                  <span>üè• Klinik: ${doctor.clinic_code}</span>
                  <span>üìÖ ${new Date(doctor.created_at).toLocaleDateString("tr-TR")}</span>
                </div>
                <div class="doctor-meta">
                  <span class="status-badge status-${doctor.status.toLowerCase()}">${getStatusText(doctor.status)}</span>
                  <span class="role-badge">DOCTOR</span>
                </div>
              </div>
              <div class="doctor-actions">
                <button class="btn btn-sm btn-success" onclick="approveDoctor('${doctor.doctor_id}')" ${doctor.status === 'PENDING' ? '' : 'disabled'}>‚úÖ Onayla</button>
                <button class="btn btn-sm btn-danger" onclick="rejectDoctor('${doctor.doctor_id}')" ${doctor.status === 'PENDING' ? '' : 'disabled'}>‚ùå Reddet</button>
                <button class="btn btn-sm btn-info" onclick="viewDetails('${doctor.doctor_id}')">üëÅ Detaylar</button>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function renderTreatmentGroups() {
      const container = document.getElementById("groups-grid");
      const emptyContainer = document.getElementById("groups-empty");
      
      if (filteredGroups.length === 0) {
        container.style.display = "none";
        emptyContainer.style.display = "flex";
      } else {
        container.style.display = "grid";
        emptyContainer.style.display = "none";
        
        container.innerHTML = filteredGroups.map(group => `
          <div class="group-card" data-id="${group.id}">
            <div class="group-header">
              <div class="group-info">
                <div class="group-name">${group.group_name}</div>
                <div class="group-status ${group.status.toLowerCase()}">${getStatusText(group.status)}</div>
              </div>
              <div class="group-actions">
                <button class="btn btn-sm btn-info" onclick="viewGroupDetails('${group.id}')">üëÅ Detaylar</button>
                <button class="btn btn-sm btn-warning" onclick="editGroup('${group.id}')">‚úèÔ∏è D√ºzenle</button>
                <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')">üóëÔ∏è Sil</button>
              </div>
            </div>
            <div class="group-stats">
              <div class="stat">
                <div class="stat-number">${group.member_count || 0}</div>
                <div class="stat-label">Doktor</div>
              </div>
              <div class="stat">
                <div class="stat-number">${group.patient_count || 0}</div>
                <div class="stat-label">Hasta</div>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function renderPatients() {
      const container = document.getElementById("patients-grid");
      const emptyContainer = document.getElementById("patients-empty");
      
      if (filteredPatients.length === 0) {
        container.style.display = "none";
        emptyContainer.style.display = "flex";
      } else {
        container.style.display = "grid";
        emptyContainer.style.display = "none";
        
        container.innerHTML = filteredPatients.map(patient => `
          <div class="patient-card" data-id="${patient.id}">
            <div class="patient-header">
              <div class="patient-info">
                <div class="patient-name">${patient.name}</div>
                <div class="patient-details">${patient.phone} ‚Ä¢ ${patient.referralCode}</div>
              </div>
              <div class="patient-actions">
                <button class="btn btn-sm btn-info" onclick="viewPatientDetails('${patient.id}')">üëÅ Detaylar</button>
                <button class="btn btn-sm btn-warning" onclick="unassignPatient('${patient.id}')">üî§ √áƒ±kar</button>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    // Treatment Group Management
    function showCreateGroupModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>ü¶∑ Yeni Tedavi Grubu Olu≈ütur</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <form id="create-group-form">
            <div class="form-group">
              <label for="group-name">Grup Adƒ±</label>
              <input type="text" id="group-name" required placeholder="√ñrn: 'Ortodonti Tedavi Grubu 1'">
            </div>
            <div class="form-group">
              <label for="group-description">A√ßƒ±klama</label>
              <textarea id="group-description" rows="3" placeholder="Grup a√ßƒ±klamasƒ±..."></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal()">ƒ∞ptal</button>
              <button type="submit" class="btn btn-primary">Olu≈ütur</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      
      // Handle form submission
      document.getElementById('create-group-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createTreatmentGroup();
      });
    }

    async function createTreatmentGroup() {
      const token = localStorage.getItem("admin_token");
      const groupName = document.getElementById('group-name').value.trim();
      const description = document.getElementById('group-description').value.trim();
      
      if (!groupName) {
        alert('Grup adƒ± zorunludur.');
        return;
      }

      try {
        const response = await fetch("/api/treatment-groups", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            group_name: groupName,
            description: description
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.ok) {
          allGroups.push(data.group);
          filteredGroups = [...allGroups];
          renderTreatmentGroups();
          closeModal();
          alert('‚úÖ Tedavi grubu olu≈üturuldu!');
        } else {
          throw new Error(data.error || "Grup olu≈üturulamadƒ±.");
        }
      } catch (error) {
        console.error("Create group error:", error);
        alert(`‚ùå Grup olu≈üturulamadƒ±: ${error.message}`);
      }
    }

    function editGroup(groupId) {
      const group = allGroups.find(g => g.id === groupId);
      if (!group) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>ü¶∑ Tedavi Grubu D√ºzenle</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <form id="edit-group-form">
            <div class="form-group">
              <label for="edit-group-name">Grup Adƒ±</label>
              <input type="text" id="edit-group-name" value="${group.group_name}" required>
            </div>
            <div class="form-group">
              <label for="edit-group-description">A√ßƒ±klama</label>
              <textarea id="edit-group-description" rows="3">${group.description || ''}</textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal()">ƒ∞ptal</button>
              <button type="submit" class="btn btn-primary">Kaydet</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      
      // Handle form submission
      document.getElementById('edit-group-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateTreatmentGroup(groupId);
      });
    }

    async function updateTreatmentGroup(groupId) {
      const token = localStorage.getItem("admin_token");
      const groupName = document.getElementById('edit-group-name').value.trim();
      const description = document.getElementById('edit-group-description').value.trim();
      
      if (!groupName) {
        alert('Grup adƒ± zorunludur.');
        return;
      }

      try {
        const response = await fetch(`/api/treatment-groups/${groupId}`, {
          method: "PATCH",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            group_name: groupName,
            description: description
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.ok) {
          const index = allGroups.findIndex(g => g.id === groupId);
          if (index !== -1) {
            allGroups[index] = data.group;
          }
          filteredGroups = [...allGroups];
          renderTreatmentGroups();
          closeModal();
          alert('‚úÖ Grup g√ºncellendi!');
        } else {
          throw new Error(data.error || "Grup g√ºncellenemedi.");
        }
      } catch (error) {
        console.error("Update group error:", error);
        alert(`‚ùå Grup g√ºncellenemedi: ${error.message}`);
      }
    }

    async function deleteGroup(groupId) {
      if (!confirm('Bu grubu silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
        return;
      }

      try {
        const token = localStorage.getItem("admin_token");
        const response = await fetch(`/api/treatment-groups/${groupId}`, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.ok) {
          allGroups = allGroups.filter(g => g.id !== groupId);
          filteredGroups = filteredGroups.filter(g => g.id !== groupId);
          renderTreatmentGroups();
          alert('‚úÖ Grup silindi!');
        } else {
          throw new Error(data.error || "Grup silinemedi.");
        }
      } catch (error) {
        console.error("Delete group error:", error);
        alert(`‚ùå Grup silinemedi: ${error.message}`);
      }
    }

    async function showAssignPatientModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>üë• Hasta Gruba Ata</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <form id="assign-patient-form">
            <div class="form-group">
              <label for="group-select">Tedavi Grubu</label>
              <select id="group-select" required>
                <option value="">Grup se√ßin...</option>
                ${allGroups.map(group => `<option value="${group.id}">${group.group_name}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label for="patient-select">Hasta</label>
              <select id="patient-select" required>
                <option value="">Hasta se√ßin...</option>
                ${allPatients.map(patient => `<option value="${patient.id}">${patient.name} (${patient.phone})</option>`).join('')}
              </select>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal()">ƒ∞ptal</button>
              <button type="submit" class="btn btn-primary">Ata</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
      
      // Handle form submission
      document.getElementById('assign-patient-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await assignPatientToGroup();
      });
    }

    async function assignPatientToGroup() {
      const token = localStorage.getItem("admin_token");
      const groupId = document.getElementById('group-select').value;
      const patientId = document.getElementById('patient-select').value;
      
      if (!groupId || !patientId) {
        alert('L√ºtfen alanlarƒ± doldur.');
        return;
      }

      try {
        const response = await fetch("/api/patient-group-assignments", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            treatment_group_id: groupId,
            patient_id: patientId
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.ok) {
          // Update patient's group assignments
          const patient = allPatients.find(p => p.id === patientId);
          if (patient) {
            patient.treatment_groups = patient.treatment_groups || [];
          }
          
          renderPatients();
          closeModal();
          alert('‚úÖ Hasta gruba atandƒ±!');
        } else {
          throw new Error(data.error || "Hasta atanamadƒ±.");
        }
      } catch (error) {
        console.error("Assign patient error:", error);
        alert(`‚ùå Hasta atanamadƒ±: ${error.message}`);
      }
    }

    async function unassignPatient(patientId) {
      if (!confirm('Hastayƒ± gruptan ayƒ±rmak istediƒüinizden emin misiniz?')) {
        return;
      }

      try {
        const token = localStorage.getItem("admin_token");
        const response = await fetch(`/api/patient-group-assignments/${patientId}`, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.ok) {
          // Update patient's group assignments
          const patient = allPatients.find(p => p.id === patientId);
          if (patient) {
            patient.treatment_groups = [];
          }
          
          renderPatients();
          alert('‚úÖ Hasta gruptan ayrƒ±ldƒ±!');
        } else {
          throw new Error(data.error || "Hasta gruptan ayrƒ±ldƒ±rƒ±ldƒ±.");
        }
      } catch (error) {
        console.error("Unassign patient error:", error);
        alert(`‚ùå Hasta gruptan ayrƒ±ldƒ±rƒ±ldƒ±: ${error.message}`);
      }
    }

    // View functions
    function viewGroupDetails(groupId) {
      const group = allGroups.find(g => g.id === groupId);
      if (!group) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>ü¶∑ Grup Detaylarƒ±</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <div class="details-content">
            <div class="detail-row">
              <strong>Grup Adƒ±:</strong> ${group.group_name}
            </div>
            <div class="detail-row">
              <strong>A√ßƒ±klama:</strong> ${group.description || 'A√ßƒ±klama bulunmuyor'}
            </div>
            <div class="detail-row">
              <strong>Olu≈üturulma:</strong> ${new Date(group.created_at).toLocaleString("tr-TR")}
            </div>
            <div class="detail-row">
              <strong>Durum:</strong> ${getStatusText(group.status)}
            </div>
            <div class="detail-row">
              <strong>√úye Sayƒ±sƒ±:</strong> ${group.member_count || 0}
            </div>
            <div class="detail-row">
              <strong>Hasta Sayƒ±sƒ±:</strong> ${group.patient_count || 0}
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Kapat</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
    }

    function viewPatientDetails(patientId) {
      const patient = allPatients.find(p => p.id === patientId);
      if (!patient) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>üë• Hasta Detaylarƒ±</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <div class="details-content">
            <div class="detail-row">
              <strong>Adƒ±:</strong> ${patient.name}
            </div>
            <div class="detail-row">
              <strong>Telefon:</strong> ${patient.phone}
            </div>
            <div class="detail-row">
              <strong>Referral Kodu:</strong> ${patient.referralCode}
            </div>
            <div class="detail-row">
              <strong>Kayƒ±t:</strong> ${new Date(patient.created_at).toLocaleString("tr-TR")}
            </div>
            <div class="detail-row">
              <strong>Gruplar:</strong> ${patient.treatment_groups?.length || 0} grup atanmƒ±≈ü
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Kapat</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
    }

    function viewDetails(doctorId) {
      const doctor = allDoctors.find(d => d.doctor_id === doctorId);
      if (!doctor) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>üë®‚Äç‚öïÔ∏è Doktor Detaylarƒ±</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <div class="details-content">
            <div class="detail-row">
              <strong>Ad:</strong> ${doctor.name}
            </div>
            <div class="detail-row">
              <strong>Telefon:</strong> ${doctor.phone}
            </div>
            <div class="detail-row">
              <strong>Email:</strong> ${doctor.email || "-"}
            </div>
            <div class="detail-row">
              <strong>Klinik Kodu:</strong> ${doctor.clinic_code}
            </div>
            <div class="detail-row">
              <strong>Durum:</strong> ${getStatusText(doctor.status)}
            </div>
            <div class="detail-row">
              <strong>Kayƒ±t:</strong> ${new Date(doctor.created_at).toLocaleString("tr-TR")}
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">Kapat</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.style.display = 'flex';
    }

    // Admin actions
    async function approveDoctor(doctorId) {
      if (!confirm("Bu doktoru onaylamak istediƒüinizden emin misiniz?")) {
        return;
      }

      try {
        const token = localStorage.getItem("admin_token");
        const response = await fetch(`/api/admin/approve-doctor`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ doctorId })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data.ok) {
          // Update doctor status
          const doctor = allDoctors.find(d => d.doctor_id === doctorId);
          if (doctor) {
            doctor.status = 'ACTIVE';
          }
          renderDoctors();
          alert('‚úÖ Doktor onaylandƒ±!');
        } else {
          throw new Error(data.error || "Doktor onaylanamadƒ±.");
        }
      } catch (error) {
        console.error("Approve doctor error:", error);
        alert(`‚ùå Doktor onaylanamadƒ±: ${error.message}`);
      }
    }

    async function rejectDoctor(doctorId) {
      if (!confirm("Bu doktor ba≈üvurusunu reddetmek istediƒüinizden emin misiniz?")) {
        return;
      }
      
      // TODO: Implement reject endpoint
      alert("üîß Reddetme √∂zelliƒüi yakƒ±nda eklenecek");
    }

    // Filter functions
    function filterDoctors() {
      const searchTerm = document.getElementById("search-input").value.toLowerCase();
      const statusFilter = document.getElementById("status-filter").value;

      filteredDoctors = allDoctors.filter(doctor => {
        const matchesSearch = !searchTerm || 
          doctor.name.toLowerCase().includes(searchTerm) ||
          (doctor.email && doctor.email.toLowerCase().includes(searchTerm)) ||
          doctor.phone.includes(searchTerm);

        const matchesStatus = !statusFilter || doctor.status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      renderDoctors();
    }

    function filterGroups() {
      const searchTerm = document.getElementById("groups-search-input")?.value.toLowerCase() || '';
      
      filteredGroups = allGroups.filter(group => {
        return group.group_name.toLowerCase().includes(searchTerm);
      });

      renderTreatmentGroups();
    }

    function filterPatients() {
      const searchTerm = document.getElementById("patients-search-input")?.value.toLowerCase() || '';
      
      filteredPatients = allPatients.filter(patient => {
        return patient.name.toLowerCase().includes(searchTerm) ||
               patient.phone.includes(searchTerm);
      });

      renderPatients();
    }

    // Section switching
    function showSection(section) {
      // Hide all sections
      document.getElementById('doctors-container').style.display = 'none';
      document.getElementById('treatment-groups-container').style.display = 'none';
      document.getElementById('patients-container').style.display = 'none';
      document.getElementById('empty-container').style.display = 'none';
      
      // Show selected section
      document.getElementById(`${section}-container`).style.display = 'block';
      
      // Update navbar active state
      document.querySelectorAll('.navbar-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`[onclick="showSection('${section}')`).classList.add('active');
      
      // Load appropriate data
      if (section === 'doctors') {
        loadApplications();
      } else if (section === 'treatment-groups') {
        loadTreatmentGroups();
      } else if (section === 'patients') {
        loadPatients();
      }
    }

    function closeModal() {
      const modal = document.querySelector('.modal');
      if (modal) {
        modal.remove();
      }
    }

    function getStatusText(status) {
      const statusMap = {
        'PENDING': 'Beklemede',
        'ACTIVE': 'Aktif',
        'REJECTED': 'Reddedildi',
        'INACTIVE': 'Pasif'
      };
      return statusMap[status] || status;
    }

    // Event listeners
    document.getElementById("search-input").addEventListener("input", filterDoctors);
    document.getElementById("status-filter").addEventListener("change", filterDoctors);
    document.getElementById("groups-search-input")?.addEventListener("input", filterGroups);
    document.getElementById("patients-search-input")?.addEventListener("input", filterPatients);

    // Load on page load
    document.addEventListener("DOMContentLoaded", () => {
      showSection('doctors');
    });
  </script>
</body>
</html>
