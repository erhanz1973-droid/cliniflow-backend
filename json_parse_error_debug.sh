#!/bin/bash

echo "ğŸ”§ JSON Parse Error Debug - Encounter Endpoint"
echo "==============================================="

echo ""
echo "ğŸš¨ PROBLEM TESPÄ°T EDÄ°LDÄ°:"
echo "   âŒ Frontend: POST /api/encounter/start"
echo "   âœ… Backend: POST /api/doctor/encounters"
echo "   âŒ Endpoint mismatch â†’ 404 â†’ HTML response (index.html)"
echo "   âŒ JSON.parse() HTML'i parse edemiyor â†’ SyntaxError"

echo ""
echo "âœ… DOÄRU ENDPOINT BÄ°LGÄ°SÄ°:"
echo "   ğŸ“„ POST /api/doctor/encounters"
echo "   ğŸ” Auth: await verifyDoctorToken(req)"
echo "   ğŸ“¥ Input: { patient_id, notes }"
echo "   ğŸ›¡ï¸ Validation: patient_id zorunlu"
echo "   ğŸ”„ Response: { ok: true, encounter: {...} }"

echo ""
echo "ğŸ” MIDDLEWARE SIRASI KONTROL EDÄ°LDÄ°:"
echo "   âœ… API routes (lines 1-10605) - Ã–NCE"
echo "   âœ… Static middleware (lines 10609-10610) - SONRA"
echo "   âœ… DoÄŸru sÄ±ralama - API route'lar HTML'den Ã¶nce Ã§alÄ±ÅŸÄ±r"
echo "   âœ… express.static() API'leri engellemiyor"

echo ""
echo "ğŸ› ï¸ DEBUG ADIMLARI (Frontend):"
echo "   1ï¸âƒ£ URL dÃ¼zelt:"
echo "      âŒ const url = '/api/encounter/start';"
echo "      âœ… const url = '/api/doctor/encounters';"
echo ""
echo "   2ï¸âƒ£ Response debug loglarÄ± ekle:"
echo "      const res = await fetch(url, options);"
echo "      const raw = await res.text();"
echo "      console.log('RAW RESPONSE:', raw);"
echo "      console.log('STATUS:', res.status);"
echo ""
echo "   3ï¸âƒ£ JSON parse gÃ¼venli hale getir:"
echo "      if (res.ok) {"
echo "        const data = JSON.parse(raw);"
echo "        return data;"
echo "      } else {"
echo "        console.error('API Error:', raw);"
echo "        throw new Error(raw);"
echo "      }"

echo ""
echo "ğŸ› ï¸ BACKEND KONTROLLER (GÃ¼venlik):"
echo "   âœ… TÃ¼m API endpoint'leri JSON dÃ¶ndÃ¼rÃ¼yor"
echo "   âœ… res.redirect() kullanÄ±mÄ± yok"
echo "   âœ… Hata durumlarÄ±: res.status(...).json({...})"
echo "   âœ… Middleware sÄ±rasÄ± doÄŸru"

echo ""
echo "ğŸ“Š BEKLENEN RESPONSE FORMATI:"
echo "   âœ… BaÅŸarÄ±lÄ±:"
echo "     {"
echo "       ok: true,"
echo "       encounter: {"
echo "         id: 'uuid',"
echo "         patient_id: 'uuid',"
echo "         doctor_id: 'uuid',"
echo "         status: 'ACTIVE',"
echo "         created_at: '2026-02-16T...'"
echo "       }"
echo "     }"
echo ""
echo "   âŒ Hata:"
echo "     { ok: false, error: 'error_code' }"

echo ""
echo "ğŸ¯ FRONTEND FIX Ã–RNEÄÄ°:"
echo ""
echo "// Ã–nceki hatalÄ± kod:"
echo "const response = await fetch('/api/encounter/start', {"
echo "  method: 'POST',"
echo "  headers: { 'Content-Type': 'application/json' },"
echo "  body: JSON.stringify({ patient_id, notes })"
echo "});"
echo "const data = await response.json(); // â† JSON Parse Error"
echo ""
echo "// DÃ¼zeltilmiÅŸ kod:"
echo "const response = await fetch('/api/doctor/encounters', {"
echo "  method: 'POST',"
echo "  headers: { "
echo "    'Content-Type': 'application/json',"
echo "    'Authorization': 'Bearer ' + token"
echo "  },"
echo "  body: JSON.stringify({ patient_id, notes })"
echo "});"
echo ""
echo "const raw = await response.text();"
echo "console.log('STATUS:', response.status);"
echo "console.log('RAW RESPONSE:', raw);"
echo ""
echo "if (!response.ok) {"
echo "  console.error('API Error:', raw);"
echo "  throw new Error(raw);"
echo "}"
echo ""
echo "const data = JSON.parse(raw);"
echo "return data;"

echo ""
echo "âœ… Ã–ZET:"
echo "   ğŸ¯ Ana sorun: Endpoint URL yanlÄ±ÅŸ"
echo "   ğŸ¯ Ã‡Ã¶zÃ¼m: /api/encounter/start â†’ /api/doctor/encounters"
echo "   ğŸ¯ Backend saÄŸlam - middleware sÄ±rasÄ± doÄŸru"
echo "   ğŸ¯ TÃ¼m API'ler JSON response dÃ¶ndÃ¼rÃ¼yor"
echo "   ğŸ¯ Frontend URL dÃ¼zeltmesi sorunu Ã§Ã¶zecek"

echo ""
echo "ğŸš€ SONUÃ‡:"
echo "   Endpoint URL dÃ¼zeltildiÄŸinde JSON parse hatasÄ± kaybolacak"
echo "   Backend zaten doÄŸru Ã§alÄ±ÅŸÄ±yor"
echo "   Sadece frontend API Ã§aÄŸrÄ±sÄ± gÃ¼ncellenmeli"
