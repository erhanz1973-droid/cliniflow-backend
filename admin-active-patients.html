<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aktif Hastalar - Clinifly Admin</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("admin_token");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root {
      --bg:#111827;
      --card:#1f2937;
      --b:#374151;
      --p:#2563eb;
      --g:#16a34a;
      --r:#dc2626;
      --y:#f59e0b;
      --muted:#a7b2c8;
      --link:#6aa6ff;
    }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#e6eaf2; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    header{ margin-bottom:20px; border-bottom:1px solid var(--b); padding-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px; }
    h1{ font-size:24px; margin:0 0 20px; font-weight:700; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--b);
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 20px;
      color: #fff;
    }
    .navbar-links {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .navbar-link {
      color: var(--muted);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .navbar-link:hover {
      background: var(--card);
      color: #fff;
    }
    .navbar-link.active {
      background: var(--p);
      color: #fff;
    }

    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:24px; }
    .stat-card{ background:var(--card); border:1px solid var(--b); border-radius:12px; padding:20px; text-align:center; }
    .stat-number{ font-size:32px; font-weight:700; color:#fff; margin-bottom:4px; }
    .stat-label{ color:var(--muted); font-size:14px; }

    .search-filter{ display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
    .search-input{ flex:1; min-width:200px; background:var(--card); border:1px solid var(--b); color:#fff; padding:12px 16px; border-radius:8px; font-size:14px; }
    .search-input::placeholder{ color:var(--muted); }
    .filter-btn{ background:var(--card); border:1px solid var(--b); color:var(--muted); padding:12px 20px; border-radius:8px; font-size:14px; cursor:pointer; transition:all 0.2s; }
    .filter-btn:hover{ background:var(--b); color:#fff; }
    .filter-btn.active{ background:var(--p); color:#fff; border-color:var(--p); }

    .patient-grid{ display:grid; gap:16px; }
    .patient-card{ background:var(--card); border:1px solid var(--b); border-radius:12px; padding:20px; display:flex; justify-content:space-between; align-items:center; transition:all 0.2s; }
    .patient-card:hover{ border-color:var(--g); transform:translateY(-1px); }
    .patient-info{ flex:1; }
    .patient-name{ font-size:18px; font-weight:600; color:#fff; margin-bottom:8px; }
    .patient-details{ color:var(--muted); font-size:14px; line-height:1.5; }
    .patient-details span{ display:block; margin-bottom:2px; }
    .patient-meta{ display:flex; align-items:center; gap:8px; margin-top:8px; }
    .status-badge{ padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; text-transform:uppercase; }
    .status-active{ background:var(--g); color:#fff; }
    .status-pending{ background:var(--y); color:#000; }
    .role-badge{ background:var(--g); color:#fff; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600; }
    .patient-actions{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .btn{ padding:8px 16px; border-radius:6px; font-size:14px; font-weight:600; text-decoration:none; text-align:center; cursor:pointer; transition:all 0.2s; border:none; }
    .btn-primary{ background:var(--p); color:#fff; }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-secondary{ background:var(--card); color:var(--muted); border:1px solid var(--b); }
    .btn-secondary:hover{ background:var(--b); color:#fff; }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .empty-state{ text-align:center; padding:60px 20px; color:var(--muted); }
    .empty-icon{ font-size:48px; margin-bottom:16px; opacity:0.5; }
    .loading{ text-align:center; padding:40px; color:var(--muted); }
    .error{ background:#3a1620; border:1px solid #5a2232; color:#ffd7df; padding:16px; border-radius:8px; margin-bottom:20px; }

    @media (max-width:768px){
      .wrap{ padding:12px; }
      .patient-card{ flex-direction:column; align-items:flex-start; gap:16px; }
      .patient-actions{ width:100%; flex-direction:row; justify-content:flex-end; }
      .navbar{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="navbar">
        <div class="navbar-left">
          <div class="navbar-logo">
            üè• Clinifly Admin
          </div>
        </div>
        <div class="navbar-links">
          <a href="/admin.html" class="navbar-link">Dashboard</a>
          <a href="/admin-patients.html" class="navbar-link active">Patients</a>
          <a href="/admin-doctor-applications.html" class="navbar-link">Doctor Applications</a>
          <a href="#" onclick="logout()" class="navbar-link">Logout</a>
        </div>
      </div>
      <h1>üë®‚Äç‚öïÔ∏è Aktif Hastalar</h1>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="active-count">-</div>
        <div class="stat-label">Aktif Hasta</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-count">-</div>
        <div class="stat-label">Bekleyen Hasta</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-count">-</div>
        <div class="stat-label">Toplam Hasta</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="clinic-count">-</div>
        <div class="stat-label">Klinik Sayƒ±sƒ±</div>
      </div>
    </div>

    <div class="search-filter">
      <input type="text" class="search-input" id="search-input" placeholder="Hasta adƒ±, email veya telefon ile ara...">
      <select class="filter-btn" id="clinic-filter">
        <option value="">T√ºm Klinikler</option>
      </select>
      <button class="filter-btn" onclick="loadPatients()">üîÑ Yenile</button>
    </div>

    <div id="error-container"></div>
    <div id="loading-container" class="loading" style="display:none;">
      <div>üîÑ Y√ºkleniyor...</div>
    </div>
    <div id="patients-container" class="patient-grid"></div>
    <div id="empty-container" class="empty-state" style="display:none;">
      <div class="empty-icon">üë•</div>
      <div>Hen√ºz aktif hasta bulunmuyor</div>
    </div>
  </div>

  <script>
    let allPatients = [];
    let filteredPatients = [];
    let clinics = new Set();

    async function loadPatients() {
      const token = localStorage.getItem("admin_token");
      const loadingContainer = document.getElementById("loading-container");
      const errorContainer = document.getElementById("error-container");
      const patientsContainer = document.getElementById("patients-container");
      const emptyContainer = document.getElementById("empty-container");

      loadingContainer.style.display = "block";
      errorContainer.innerHTML = "";
      patientsContainer.innerHTML = "";
      emptyContainer.style.display = "none";

      try {
        const response = await fetch("/api/admin/active-patients", {
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const data = await response.json();

        if (data.ok) {
          allPatients = data.patients || [];
          filteredPatients = [...allPatients];
          
          // Extract unique clinics
          clinics = new Set(allPatients.map(p => p.clinic_code));
          updateClinicFilter();
          
          updateStats();
          renderPatients();
        } else {
          throw new Error(data.error || "Hastalar y√ºklenemedi");
        }
      } catch (error) {
        console.error("Load patients error:", error);
        errorContainer.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
      } finally {
        loadingContainer.style.display = "none";
      }
    }

    function updateClinicFilter() {
      const clinicFilter = document.getElementById("clinic-filter");
      const currentValue = clinicFilter.value;
      
      clinicFilter.innerHTML = '<option value="">T√ºm Klinikler</option>';
      
      Array.from(clinics).sort().forEach(clinic => {
        const option = document.createElement("option");
        option.value = clinic;
        option.textContent = clinic;
        clinicFilter.appendChild(option);
      });
      
      clinicFilter.value = currentValue;
    }

    function updateStats() {
      const active = allPatients.filter(p => p.status === "ACTIVE").length;
      const pending = allPatients.filter(p => p.status === "PENDING").length;
      const total = allPatients.length;

      document.getElementById("active-count").textContent = active;
      document.getElementById("pending-count").textContent = pending;
      document.getElementById("total-count").textContent = total;
      document.getElementById("clinic-count").textContent = clinics.size;
    }

    function renderPatients() {
      const container = document.getElementById("patients-container");
      const emptyContainer = document.getElementById("empty-container");

      if (filteredPatients.length === 0) {
        container.innerHTML = "";
        emptyContainer.style.display = "block";
        return;
      }

      container.innerHTML = filteredPatients.map(patient => `
        <div class="patient-card">
          <div class="patient-info">
            <div class="patient-name">${patient.name}</div>
            <div class="patient-details">
              <span>üì± ${patient.phone}</span>
              ${patient.email ? `<span>üìß ${patient.email}</span>` : ""}
              <span>üè• Klinik: ${patient.clinic_code}</span>
              <span>üìÖ ${new Date(patient.created_at).toLocaleDateString("tr-TR")}</span>
            </div>
            <div class="patient-meta">
              <span class="status-badge status-${patient.status.toLowerCase()}">${getStatusText(patient.status)}</span>
              <span class="role-badge">PATIENT</span>
            </div>
          </div>
          <div class="patient-actions">
            <button class="btn btn-primary" onclick="viewDetails('${patient.patient_id}')">üëÅÔ∏è Detaylar</button>
            <button class="btn btn-secondary" onclick="viewTreatments('${patient.patient_id}')">ü¶∑ Tedaviler</button>
          </div>
        </div>
      `).join("");
    }

    function getStatusText(status) {
      const statusMap = {
        "ACTIVE": "Aktif",
        "PENDING": "Bekleyen",
        "REJECTED": "Reddedildi"
      };
      return statusMap[status] || status;
    }

    function viewDetails(patientId) {
      const patient = allPatients.find(p => p.patient_id === patientId);
      if (!patient) return;

      alert(`üë®‚Äç‚öïÔ∏è Hasta Detaylarƒ±\n\nAd: ${patient.name}\nTelefon: ${patient.phone}\nEmail: ${patient.email || "-"}\nKlinik: ${patient.clinic_code}\nDurum: ${getStatusText(patient.status)}\nKayƒ±t: ${new Date(patient.created_at).toLocaleString("tr-TR")}`);
    }

    function viewTreatments(patientId) {
      const patient = allPatients.find(p => p.patient_id === patientId);
      if (!patient) return;

      // TODO: Navigate to patient treatments
      alert(`üîß ${patient.name} adlƒ± hastanƒ±n tedavi ge√ßmi≈üi yakƒ±nda g√∂r√ºnt√ºlenebilecek`);
    }

    function filterPatients() {
      const searchTerm = document.getElementById("search-input").value.toLowerCase();
      const clinicFilter = document.getElementById("clinic-filter").value;

      filteredPatients = allPatients.filter(patient => {
        const matchesSearch = !searchTerm || 
          patient.name.toLowerCase().includes(searchTerm) ||
          (patient.email && patient.email.toLowerCase().includes(searchTerm)) ||
          patient.phone.includes(searchTerm);

        const matchesClinic = !clinicFilter || patient.clinic_code === clinicFilter;

        return matchesSearch && matchesClinic;
      });

      renderPatients();
    }

    function logout() {
      localStorage.removeItem("admin_token");
      window.location.href = "/admin-login.html";
    }

    // Event listeners
    document.getElementById("search-input").addEventListener("input", filterPatients);
    document.getElementById("clinic-filter").addEventListener("change", filterPatients);

    // Load on page load
    document.addEventListener("DOMContentLoaded", loadPatients);
  </script>
</body>
</html>
