<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Admin Travel (Timeline + Treatment Events)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui; background:#0f172a; color:#e5e7eb; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 20px; background:#020617; border-radius: 12px; }
    h1 { margin: 0 0 10px; }
    .muted { opacity:.75; font-size: 13px; }
    label { display:block; margin-top: 10px; font-weight: 600; }
    input, textarea, button, select {
      width:100%; margin-top:6px; padding:10px 12px;
      border-radius:8px; border:1px solid #1f2937; background:#020617; color:#e5e7eb;
    }
    button { cursor:pointer; background:#2563eb; border:none; }
    button:hover { background:#1d4ed8; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .card { margin-top: 14px; padding: 14px; border:1px solid #1f2937; border-radius:10px; background:#020617; }
    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap: wrap; }
    .btn2 { background:#0ea5e9; }
    .btn2:hover { background:#0284c7; }
    .danger { background:#ef4444; }
    .danger:hover { background:#dc2626; }
    .ok { color:#22c55e; }
    .err { color:#ef4444; }
    pre { white-space:pre-wrap; margin: 0; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #1f2937; padding: 10px 8px; text-align:left; vertical-align: top; }
    th { opacity:.8; font-weight:700; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size: 12px; opacity:.9; }

    /* timeline */
    .tl { margin-top: 10px; }
    .tlItem {
      display:grid;
      grid-template-columns: 140px 14px 1fr;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #111827;
      align-items: start;
    }
    .tlTime { font-size: 12px; opacity:.85; }
    .dot { width: 12px; height: 12px; border-radius: 999px; background:#2563eb; margin-top: 4px; }
    .dot.hotel { background:#22c55e; }
    .dot.note { background:#a78bfa; }
    .dot.out { background:#38bdf8; }
    .dot.ret { background:#f59e0b; }
    .dot.tx { background:#fb7185; } /* treatment */
    .tlTitle { font-weight: 800; }
    .tlDesc { opacity:.88; margin-top: 2px; font-size: 13px; }
    .tlMeta { opacity:.75; font-size: 12px; margin-top: 6px; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 820px){
      .row3, .split, .grid { grid-template-columns: 1fr; }
      .tlItem{ grid-template-columns: 120px 14px 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Ä¢ Travel</h1>
    <div class="muted">
      API: <code id="apiBaseText"></code><code>/api/patient/&lt;patientId&gt;/travel</code>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Patient ID</label>
          <input id="patientId" value="p2" />
        </div>
        <div>
          <label>API Base</label>
          <input id="apiBase" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Otel Adƒ±</label>
          <input id="hotelName" placeholder="Radisson Blu" />
        </div>
        <div>
          <label>Notlar</label>
          <textarea id="notes" rows="2" placeholder="opsiyonel not"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn2" onclick="loadTravel()">GET ‚Ä¢ Y√ºkle</button>
        <button onclick="saveTravel()">POST ‚Ä¢ Kaydet</button>
      </div>

      <div id="status" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">‚úàÔ∏è U√ßu≈ü Formu</h3>

      <div class="row3">
        <div>
          <label>Havayolu (ops.)</label>
          <input id="f_airline" placeholder="Turkish Airlines" />
        </div>
        <div>
          <label>Flight No (ops.)</label>
          <input id="f_flightNo" placeholder="TK 1234" />
        </div>
        <div>
          <label>PNR (ops.)</label>
          <input id="f_pnr" placeholder="ABC123" />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Kalkƒ±≈ü (IATA)</label>
          <input id="f_from" placeholder="IST" />
        </div>
        <div>
          <label>Varƒ±≈ü (IATA)</label>
          <input id="f_to" placeholder="TBS" />
        </div>
        <div>
          <label>Not (ops.)</label>
          <input id="f_note" placeholder="bagaj/koltuk vb." />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Tarih</label>
          <input id="f_date" type="date" />
        </div>
        <div>
          <label>Saat (ops.)</label>
          <input id="f_time" type="time" />
        </div>
        <div>
          <label>Form</label>
          <button class="danger" onclick="clearFlightForm()">Formu Temizle</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn2" onclick="addFlight('OUTBOUND')">‚ûï Gidi≈ü U√ßu≈üu Ekle</button>
        <button class="btn2" onclick="addFlight('RETURN')">‚ûï D√∂n√º≈ü U√ßu≈üu Ekle</button>
      </div>

      <div style="margin-top:10px;" class="muted">
        <span class="pill">Zorunlu</span> from, to, date
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">ü¶∑ Treatment Event Ekle</h3>

      <div class="row3">
        <div>
          <label>Tarih</label>
          <input id="e_date" type="date" />
        </div>
        <div>
          <label>Saat</label>
          <input id="e_time" type="time" />
        </div>
        <div>
          <label>Tip</label>
          <select id="e_type">
            <option value="TREATMENT">Treatment</option>
            <option value="CONSULT">Consultation</option>
            <option value="FOLLOWUP">Follow-up</option>
            <option value="LAB">Lab / Scan</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Ba≈ülƒ±k</label>
          <input id="e_title" placeholder="Implant Day 1" />
        </div>
        <div>
          <label>A√ßƒ±klama (ops.)</label>
          <input id="e_desc" placeholder="CT scan + implant placement" />
        </div>
      </div>

      <div class="actions">
        <button class="btn2" onclick="addEvent()">‚ûï Event Ekle</button>
        <button class="danger" onclick="clearEventForm()">Formu Temizle</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        <span class="pill">Not</span> Event‚Äôler <code>travel.events</code> altƒ±nda saklanƒ±r.
      </div>
    </div>

    <div class="card">
      <div class="split">
        <div>
          <h3 style="margin:0 0 8px;">Gidi≈ü</h3>
          <table>
            <thead><tr><th>Rota</th><th>Tarih/Saat</th><th></th></tr></thead>
            <tbody id="outBody"></tbody>
          </table>
        </div>
        <div>
          <h3 style="margin:0 0 8px;">D√∂n√º≈ü</h3>
          <table>
            <thead><tr><th>Rota</th><th>Tarih/Saat</th><th></th></tr></thead>
            <tbody id="retBody"></tbody>
          </table>
        </div>
      </div>

      <h3 style="margin:14px 0 8px;">Treatment Events</h3>
      <table>
        <thead><tr><th>Tarih/Saat</th><th>Tip</th><th>Ba≈ülƒ±k</th><th></th></tr></thead>
        <tbody id="evBody"></tbody>
      </table>

      <div class="actions">
        <button onclick="saveTravel()">POST ‚Ä¢ Kaydet</button>
        <button class="btn2" onclick="loadTravel()">GET ‚Ä¢ Yenile</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">üïí Timeline (U√ßu≈ü + Otel + Treatment + Notlar)</h3>
      <div id="timeline" class="tl muted">‚Äî</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Son Response</h3>
      <pre id="lastResp" class="muted">‚Äî</pre>
    </div>
  </div>

<script>
  const DEFAULT_API_BASE = (location.origin && location.origin.startsWith("http"))
    ? location.origin
    : "http://127.0.0.1:5050";

  let state = { hotel: null, flights: [], notes: "", events: [] };
  const $ = (id) => document.getElementById(id);

  function setStatus(msg, ok=true){
    $("status").innerHTML = ok ? `<span class="ok">‚úÖ ${msg}</span>` : `<span class="err">‚ùå ${msg}</span>`;
  }
  function apiBase(){ return $("apiBase").value.trim() || DEFAULT_API_BASE; }
  function endpoint(pid){ return `${apiBase()}/api/patient/${encodeURIComponent(pid)}/travel`; }

  function toSortableTs(dateStr, timeStr){
    if(!dateStr) return 0;
    const t = timeStr ? timeStr : "00:00";
    const iso = `${dateStr}T${t}:00`;
    const ts = Date.parse(iso);
    return Number.isFinite(ts) ? ts : 0;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function detailText(f){
    const parts = [];
    if (f.airline) parts.push(`Airline: ${f.airline}`);
    if (f.flightNo) parts.push(`No: ${f.flightNo}`);
    if (f.pnr) parts.push(`PNR: ${f.pnr}`);
    if (f.note) parts.push(`Note: ${f.note}`);
    return parts.join(" ‚Ä¢ ") || "-";
  }

  function renderTables(){
    const flights = Array.isArray(state.flights) ? state.flights : [];
    const outbound = flights.filter(f => (f.type || "OUTBOUND") === "OUTBOUND");
    const ret = flights.filter(f => (f.type || "") === "RETURN");

    const outBody = $("outBody");
    const retBody = $("retBody");
    outBody.innerHTML = "";
    retBody.innerHTML = "";

    function rowSimple(f){
      const route = `${String(f.from||"").toUpperCase()} ‚Üí ${String(f.to||"").toUpperCase()}`;
      const dt = `${f.date || "-"} ${f.time || ""}`.trim();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${route}</td>
        <td class="muted">${dt}</td>
        <td style="width:120px;"><button class="danger" onclick="removeFlight('${f.id}')">Sil</button></td>
      `;
      return tr;
    }

    if(outbound.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="3">Gidi≈ü yok.</td>`;
      outBody.appendChild(tr);
    } else outbound.forEach(f => outBody.appendChild(rowSimple(f)));

    if(ret.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="3">D√∂n√º≈ü yok.</td>`;
      retBody.appendChild(tr);
    } else ret.forEach(f => retBody.appendChild(rowSimple(f)));

    // events table
    const ev = Array.isArray(state.events) ? state.events : [];
    const evBody = $("evBody");
    evBody.innerHTML = "";
    if(ev.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="4">Event yok.</td>`;
      evBody.appendChild(tr);
    } else {
      // sƒ±ralƒ± g√∂ster
      const sorted = [...ev].sort((a,b)=> (toSortableTs(a.date,a.time)||0) - (toSortableTs(b.date,b.time)||0));
      sorted.forEach(e => {
        const dt = `${e.date || "-"} ${e.time || ""}`.trim();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="muted">${escapeHtml(dt)}</td>
          <td>${escapeHtml(e.type || "TREATMENT")}</td>
          <td>${escapeHtml(e.title || "-")}<div class="muted" style="margin-top:4px;">${escapeHtml(e.desc||"")}</div></td>
          <td style="width:120px;"><button class="danger" onclick="removeEvent('${e.id}')">Sil</button></td>
        `;
        evBody.appendChild(tr);
      });
    }
  }

  function renderTimeline(){
    const el = $("timeline");
    const items = [];

    // flights
    (Array.isArray(state.flights) ? state.flights : []).forEach(f => {
      const ts = toSortableTs(f.date, f.time);
      const isReturn = (f.type === "RETURN");
      const title = isReturn ? "D√∂n√º≈ü U√ßu≈üu" : "Gidi≈ü U√ßu≈üu";
      const dotClass = isReturn ? "ret" : "out";
      const route = `${String(f.from||"").toUpperCase()} ‚Üí ${String(f.to||"").toUpperCase()}`;
      const when = `${f.date || "-"} ${f.time || ""}`.trim();
      items.push({
        ts,
        dotClass,
        timeText: when || "-",
        title: `${title} ‚Ä¢ ${route}`,
        desc: detailText(f),
        meta: (f.pnr ? `PNR: ${f.pnr}` : "")
      });
    });

    // treatment events
    (Array.isArray(state.events) ? state.events : []).forEach(e => {
      const ts = toSortableTs(e.date, e.time);
      const when = `${e.date || "-"} ${e.time || ""}`.trim();
      items.push({
        ts,
        dotClass: "tx",
        timeText: when || "-",
        title: `${e.type || "TREATMENT"} ‚Ä¢ ${e.title || "-"}`,
        desc: e.desc || "",
        meta: ""
      });
    });

    // hotel
    if (state.hotel && state.hotel.name){
      // check-in‚Äôi gidi≈ü sonrasƒ± gibi yerle≈ütirmek i√ßin:
      const outTs = items.filter(x=>x.dotClass==="out").sort((a,b)=>a.ts-b.ts)[0]?.ts || 0;
      const ts = outTs ? (outTs + 60*60*1000) : 0;
      items.push({
        ts,
        dotClass: "hotel",
        timeText: outTs ? "Check-in (tahmini)" : "-",
        title: `Otel ‚Ä¢ ${state.hotel.name}`,
        desc: "Konaklama",
        meta: ""
      });
    }

    // notes
    if (state.notes && state.notes.trim()){
      const maxTs = items.reduce((m,x)=>Math.max(m, x.ts||0), 0);
      items.push({
        ts: maxTs ? (maxTs + 1) : 0,
        dotClass: "note",
        timeText: "Not",
        title: "Notlar",
        desc: state.notes.trim(),
        meta: ""
      });
    }

    items.sort((a,b) => {
      const ta = a.ts || 0, tb = b.ts || 0;
      if (ta === 0 && tb === 0) return 0;
      if (ta === 0) return 1;
      if (tb === 0) return -1;
      return ta - tb;
    });

    if (items.length === 0){
      el.textContent = "Hen√ºz timeline verisi yok.";
      return;
    }

    el.innerHTML = items.map(it => `
      <div class="tlItem">
        <div class="tlTime">${escapeHtml(it.timeText)}</div>
        <div class="dot ${it.dotClass}"></div>
        <div>
          <div class="tlTitle">${escapeHtml(it.title)}</div>
          <div class="tlDesc">${escapeHtml(it.desc || "-")}</div>
          ${it.meta ? `<div class="tlMeta">${escapeHtml(it.meta)}</div>` : ``}
        </div>
      </div>
    `).join("");
  }

  function renderAll(){
    renderTables();
    renderTimeline();
  }

  function normalizeFromServer(j){
    state = {
      hotel: j.hotel ?? null,
      flights: Array.isArray(j.flights) ? j.flights : [],
      notes: typeof j.notes === "string" ? j.notes : "",
      events: Array.isArray(j.events) ? j.events : []
    };
    $("hotelName").value = state.hotel?.name || "";
    $("notes").value = state.notes || "";
    renderAll();
  }

  async function loadTravel(){
    const pid = $("patientId").value.trim();
    if(!pid) return setStatus("patientId bo≈ü", false);

    try{
      const r = await fetch(endpoint(pid));
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      normalizeFromServer(j);
      $("lastResp").textContent = JSON.stringify(j, null, 2);
      setStatus("GET ba≈üarƒ±lƒ±. Veri y√ºklendi.");
    }catch(e){
      setStatus("GET hata: " + e.message, false);
    }
  }

  async function saveTravel(){
    const pid = $("patientId").value.trim();
    if(!pid) return setStatus("patientId bo≈ü", false);

    const hotelName = $("hotelName").value.trim();
    const notes = $("notes").value;

    const payload = {
      hotel: hotelName ? { name: hotelName } : null,
      flights: Array.isArray(state.flights) ? state.flights : [],
      notes: notes || "",
      events: Array.isArray(state.events) ? state.events : []
    };

    try{
      const r = await fetch(endpoint(pid), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const text = await r.text();
      if(!r.ok) throw new Error(`HTTP ${r.status} ‚Üí ${text}`);

      let j = null;
      try { j = JSON.parse(text); } catch {}
      if (j && j.travel) normalizeFromServer(j.travel);

      $("lastResp").textContent = j ? JSON.stringify(j, null, 2) : text;
      setStatus("POST ba≈üarƒ±lƒ±. Kaydedildi.");
    }catch(e){
      setStatus("POST hata: " + e.message, false);
      $("lastResp").textContent = String(e.message || e);
    }
  }

  function addFlight(type){
    const f = {
      id: String(Date.now()),
      type,
      airline: $("f_airline").value.trim() || "",
      flightNo: $("f_flightNo").value.trim() || "",
      from: $("f_from").value.trim() || "",
      to: $("f_to").value.trim() || "",
      date: $("f_date").value || "",
      time: $("f_time").value || "",
      pnr: $("f_pnr").value.trim() || "",
      note: $("f_note").value.trim() || ""
    };

    if (!f.from || !f.to || !f.date){
      return setStatus("U√ßu≈ü i√ßin en az: from, to, date gerekli.", false);
    }

    state.flights = Array.isArray(state.flights) ? state.flights : [];
    state.flights.push(f);
    renderAll();
    setStatus((type === "RETURN" ? "D√∂n√º≈ü" : "Gidi≈ü") + " u√ßu≈üu eklendi. (Kaydet'e bas)");
  }

  function removeFlight(id){
    state.flights = Array.isArray(state.flights) ? state.flights : [];
    state.flights = state.flights.filter(f => String(f.id) !== String(id));
    renderAll();
    setStatus("U√ßu≈ü silindi. (Kaydet'e bas)");
  }

  function clearFlightForm(){
    $("f_airline").value = "";
    $("f_flightNo").value = "";
    $("f_from").value = "";
    $("f_to").value = "";
    $("f_date").value = "";
    $("f_time").value = "";
    $("f_pnr").value = "";
    $("f_note").value = "";
    setStatus("U√ßu≈ü formu temizlendi.");
  }

  function addEvent(){
    const e = {
      id: String(Date.now()),
      date: $("e_date").value || "",
      time: $("e_time").value || "",
      type: $("e_type").value || "TREATMENT",
      title: $("e_title").value.trim() || "",
      desc: $("e_desc").value.trim() || ""
    };
    if(!e.date || !e.title){
      return setStatus("Event i√ßin en az: date ve title gerekli.", false);
    }
    state.events = Array.isArray(state.events) ? state.events : [];
    state.events.push(e);
    renderAll();
    setStatus("Treatment event eklendi. (Kaydet'e bas)");
  }

  function removeEvent(id){
    state.events = Array.isArray(state.events) ? state.events : [];
    state.events = state.events.filter(e => String(e.id) !== String(id));
    renderAll();
    setStatus("Event silindi. (Kaydet'e bas)");
  }

  function clearEventForm(){
    $("e_date").value = "";
    $("e_time").value = "";
    $("e_title").value = "";
    $("e_desc").value = "";
    setStatus("Event formu temizlendi.");
  }

  // init
  $("apiBase").value = DEFAULT_API_BASE;
  $("apiBaseText").textContent = DEFAULT_API_BASE;
  renderAll();
</script>
</body>
</html>
