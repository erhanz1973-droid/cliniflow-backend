<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tedavi Grubu Olu≈ütur - Clinifly Admin</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("adminToken");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();

    // AbortSignal.timeout polyfill
    if (!AbortSignal.timeout) {
      AbortSignal.timeout = function(ms) {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), ms);
        return controller.signal;
      };
    }
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root {
      --bg:#111827;
      --card:#1f2937;
      --b:#374151;
      --p:#2563eb;
      --g:#16a34a;
      --r:#dc2626;
      --y:#f59e0b;
      --muted:#a7b2c8;
      --link:#6aa6ff;
    }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#e6eaf2; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    header{ margin-bottom:20px; border-bottom:1px solid var(--b); padding-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px; }
    h1{ font-size:24px; margin:0 0 20px; font-weight:700; }
    .btn{ padding:10px 16px; border-radius:6px; border:none; font-weight:600; cursor:pointer; font-size:14px; transition:all .2s; }
    .btn:hover{ opacity:.85; transform:translateY(-1px); }
    .btn-primary{ background:var(--p); color:#fff; }
    .btn-secondary{ background:var(--b); color:#fff; }
    .btn-success{ background:var(--g); color:#fff; }
    .btn-danger{ background:var(--r); color:#fff; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none !important; }
    .card{ background:var(--card); border-radius:12px; padding:24px; margin-bottom:20px; border:1px solid var(--b); }
    .form-group{ margin-bottom:20px; }
    .form-label{ display:block; margin-bottom:8px; font-weight:600; color:#fff; }
    .form-input{ width:100%; padding:12px; border-radius:8px; border:1px solid var(--b); background:var(--bg); color:#fff; font-size:16px; box-sizing:border-box; }
    .form-input:focus{ outline:none; border-color:var(--p); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
    .form-textarea{ min-height:100px; resize:vertical; }
    .doctors-list{ margin-top:16px; }
    .doctor-item{ display:flex; align-items:center; padding:16px; background:var(--bg); border-radius:8px; margin-bottom:8px; border:1px solid var(--b); cursor:pointer; transition:all .2s; }
    .doctor-item:hover{ border-color:var(--p); background:rgba(37,99,235,0.05); }
    .doctor-item.selected{ border-color:var(--p); background:rgba(37,99,235,0.1); }
    .doctor-checkbox{ margin-right:12px; }
    .doctor-checkbox input{ width:18px; height:18px; cursor:pointer; }
    .doctor-info{ flex:1; }
    .doctor-name{ font-weight:600; margin-bottom:4px; }
    .doctor-department{ color:var(--muted); font-size:14px; }
    .doctor-badge{ margin-left:12px; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; }
    .badge-primary{ background:var(--p); color:#fff; }
    .badge-secondary{ background:var(--b); color:#fff; }
    .loading{ text-align:center; padding:40px; color:var(--muted); }
    .error{ background:rgba(220,38,38,0.1); border:1px solid var(--r); color:#fca5a5; padding:12px; border-radius:8px; margin-bottom:16px; }
    .success{ background:rgba(22,163,74,0.1); border:1px solid var(--g); color:#86efac; padding:12px; border-radius:8px; margin-bottom:16px; }
    .patient-info{ background:rgba(37,99,235,0.1); border:1px solid var(--p); color:#93c5fd; padding:12px; border-radius:8px; margin-bottom:20px; }
    .patient-info strong{ color:#fff; }
    .actions{ display:flex; gap:12px; margin-top:24px; }
    .actions .btn{ flex:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üè• Tedavi Grubu Olu≈ütur</h1>
      <button class="btn btn-secondary" onclick="goBackToPatient()">
        ‚Üê Hastalara Geri D√∂n
      </button>
    </header>

    <main>
      <div id="loading" class="loading">
        <div>‚è≥ Y√ºkleniyor...</div>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      <div id="success" class="success" style="display:none;"></div>

      <div id="form-container" style="display:none;">
        <form id="createTreatmentGroupForm">
          <div class="form-group">
            <label class="form-label" for="patientSelect">Hasta Se√ßimi *</label>
            <select id="patientSelect" class="form-input" required>
              <option value="">Hasta se√ßin...</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="groupName">Grup Adƒ± *</label>
            <input 
              type="text" 
              id="groupName" 
              class="form-input" 
              placeholder="Tedavi grubu adƒ±nƒ± girin..."
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="description">A√ßƒ±klama</label>
            <textarea 
              id="description" 
              class="form-input form-textarea" 
              placeholder="Tedavi grubu a√ßƒ±klamasƒ± (opsiyonel)..."
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Doktor Se√ßimi *</label>
            <div class="doctors-list" id="doctorList">
              <div class="loading">Doktorlar y√ºkleniyor...</div>
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn btn-secondary" onclick="goBackToPatient()">
              ƒ∞ptal
            </button>
            <button type="submit" class="btn btn-primary" id="submit-btn">
              Tedavi Grubu Olu≈ütur
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    let patientId = null;
    let doctors = [];
    let selectedDoctors = new Set();
    let primaryDoctorId = null;
    let patients = [];

    // Utility functions
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function goBackToPatient() {
      // Try to get patient ID from form selection first, then URL parameter
      const currentPatientId = document.getElementById("patientSelect")?.value || patientId;
      
      if (currentPatientId) {
        // Go back to patient detail page with groups tab active
        window.location.href = `/admin-patient-detail.html?patientId=${currentPatientId}&tab=groups`;
      } else {
        // Fallback to patients list if no patient ID
        window.location.href = "/admin-patients.html";
      }
    }

    function getAdminToken() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        // Redirect to login if no token
        window.location.href = '/admin-login.html';
        return null;
      }
      return token;
    }

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successEl = document.getElementById('success');
      successEl.textContent = message;
      successEl.style.display = 'block';
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 5000);
    }

    // Load patients
    async function loadPatients() {
      try {
        const token = getAdminToken();
        if (!token) {
          throw new Error("Admin token bulunamadƒ±");
        }

        const response = await fetch("/api/admin/patients", {
          headers: {
            Authorization: "Bearer " + token,
          },
        });

        if (!response.ok) {
          throw new Error("Hastalar y√ºklenemedi");
        }

        const data = await response.json();
        if (data.ok) {
          patients = data.patients || [];
          renderPatients();
        } else {
          throw new Error(data.error || "Hastalar y√ºklenemedi");
        }
      } catch (error) {
        console.error("Load patients error:", error);
        showError("Hastalar y√ºklenemedi: " + error.message);
      }
    }

    // Render patients dropdown
    function renderPatients() {
      const patientSelect = document.getElementById('patientSelect');
      
      if (!Array.isArray(patients) || patients.length === 0) {
        console.warn("Patients list empty");  // üîç Debug
        patientSelect.innerHTML = '<option value="">Hasta bulunamadƒ±</option>';
        return;
      }

      // Clear existing options except the first one
      patientSelect.innerHTML = '<option value="">Hasta se√ßin...</option>';
      
      // Add patient options with UUID as value
      patients.forEach(patient => {
        console.log("Rendering patient:", patient);  // üîç Debug
        const option = document.createElement('option');
        option.value = patient.id;  // ‚úÖ Use UUID (patients.id)
        option.textContent = `${patient.name || "ƒ∞simsiz Hasta"} (${patient.patient_id})`;
        patientSelect.appendChild(option);
      });

      // Set selected patient if coming from URL
      if (patientId) {
        const urlPatient = patients.find(p => p.id === patientId);
        if (urlPatient) {
          patientSelect.value = patientId;
        }
      }
    }

    // Hide messages
    function hideMessages() {
      document.getElementById("error").style.display = "none";
      document.getElementById("success").style.display = "none";
    }

    // Load doctors
    async function loadDoctors() {
      try {
        const token = getAdminToken();
        if (!token) {
          throw new Error("Admin token bulunamadƒ±");
        }

        const response = await fetch("/api/admin/doctors", {
          headers: {
            Authorization: "Bearer " + token,
          },
        });

        if (!response.ok) {
          throw new Error("Doktorlar y√ºklenemedi");
        }

        const data = await response.json();
        if (data.ok) {
          doctors = data.doctors || [];
          console.log("Doctors API response:", doctors);  // 
          renderDoctors();
        } else {
          throw new Error(data.error || "Doktorlar y√ºklenemedi");
        }
      } catch (error) {
        console.error("Load doctors error:", error);
        showError("Doktorlar y√ºklenemedi: " + error.message);
      }
    }

    // Render doctors list
    function renderDoctors() {
      const doctorsList = document.getElementById("doctorList");
      
      if (!Array.isArray(doctors) || doctors.length === 0) {
        console.warn("Doctors list empty");  // üîç Debug
        doctorsList.innerHTML = "<div style='text-align:center; color:var(--muted); padding:20px;'>Aktif doktor bulunamadƒ±</div>";
        return;
      }

      doctorsList.innerHTML = doctors.map(doctor => {
        console.log("Rendering doctor:", doctor);  // üîç Debug
        const doctorName = doctor.full_name || doctor.name || "ƒ∞simsiz Doktor";
        const department = doctor.department || "B√∂l√ºm belirtilmemi≈ü";
        const isSelected = selectedDoctors.has(doctor.id);
        const isPrimary = primaryDoctorId === doctor.id;
        
        return `
          <div class="doctor-item ${isSelected ? 'selected' : ''}" 
               onclick="toggleDoctor('${doctor.id}')">
            <div class="doctor-checkbox">
              <input type="checkbox" 
                     name="doctor_ids"
                     value="${doctor.id}"
                     ${isSelected ? 'checked' : ''} 
                     onclick="event.stopPropagation(); toggleDoctor('${doctor.id}')" />
            </div>
            <div class="doctor-info">
              <div class="doctor-name">${doctorName}</div>
              <div class="doctor-department">${department}</div>
              ${isPrimary ? '<div class="doctor-primary">Birincil Doktor</div>' : ''}
            </div>
            <div class="doctor-actions">
              ${isSelected ? `<button class="btn-set-primary" onclick="event.stopPropagation(); setPrimaryDoctor('${doctor.id}')">Birincil Yap</button>` : ''}
              ${isSelected ? `<input type="radio" name="primary_doctor" value="${doctor.id}" ${isPrimary ? 'checked' : ''} />` : ''}
            </div>
          </div>
        `;
      }).join("");
    }

    // Toggle doctor selection
    function toggleDoctor(doctorId) {
      if (selectedDoctors.has(doctorId)) {
        selectedDoctors.delete(doctorId);
        if (primaryDoctorId === doctorId) {
          primaryDoctorId = null;
        }
      } else {
        selectedDoctors.add(doctorId);
        // If this is the first selection, make it primary
        if (selectedDoctors.size === 1) {
          primaryDoctorId = doctorId;
        }
      }
      renderDoctors();
    }

    // Set primary doctor
    function setPrimaryDoctor(doctorId) {
      if (selectedDoctors.has(doctorId)) {
        primaryDoctorId = doctorId;
        renderDoctors();
      }
    }

    // Initialize page
    async function initializePage() {
      try {
        // Get patient ID from URL (optional)
        patientId = getUrlParameter("patientId");

        // Load patients and doctors
        await Promise.all([loadPatients(), loadDoctors()]);

        // Show form
        document.getElementById("loading").style.display = "none";
        document.getElementById("form-container").style.display = "block";

        // Setup form submission with correct form ID
        const form = document.getElementById("createTreatmentGroupForm");
        form.addEventListener("submit", handleSubmit);

      } catch (error) {
        console.error("Initialize error:", error);
        showError("Sayfa y√ºklenemedi: " + error.message);
        document.getElementById("loading").style.display = "none";
      }
    }

    let isSubmitting = false;

    // Initialize when DOM is ready
    document.addEventListener("DOMContentLoaded", initializePage);

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();
      
      // Prevent double submission
      if (isSubmitting) {
        console.log("SUBMIT ALREADY IN PROGRESS - IGNORING");
        return;
      }
      
      isSubmitting = true;
      console.log("FORM SUBMIT STARTED");
      
      try {
        // Basic form data collection
        const formData = new FormData(document.getElementById("createTreatmentGroupForm"));
        console.log("FormData entries:", Array.from(formData.entries()));
        
        // Manual collection
        const patientId = document.getElementById("patientSelect")?.value || "";
        const name = document.getElementById("groupName")?.value || "";
        const description = document.getElementById("description")?.value || "";
        
        // Get selected doctors
        const checkboxes = document.querySelectorAll('input[name="doctor_ids"]:checked');
        const doctorIds = Array.from(checkboxes).map(cb => cb.value);
        const primaryDoctorId = doctorIds[0] || "";
        
        console.log("MANUAL COLLECTION:", {
          patientId,
          name,
          description,
          doctorIds,
          primaryDoctorId
        });
        
        // Create payload
        const payload = {
          patient_id: patientId,
          doctor_ids: doctorIds,
          primary_doctor_id: primaryDoctorId,
          name: name.trim(),
          description: description.trim()
        };
        
        console.log("FINAL PAYLOAD:", payload);
        
        // Validation
        if (!payload.patient_id || !payload.name || !payload.doctor_ids.length) {
          alert("L√ºtfen t√ºm zorunlu alanlarƒ± doldurun");
          return;
        }
        
        // Get token
        const token = localStorage.getItem('adminToken');
        if (!token) {
          alert("Admin token bulunamadƒ±");
          return;
        }
        
        // Disable submit button and change text
        const submitBtn = document.getElementById("submit-btn");
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Olu≈üturuluyor...";
        
        console.log("SENDING REQUEST...");
        
        // Send request
        const response = await fetch("/api/admin/treatment-groups", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });
        
        console.log("RESPONSE STATUS:", response.status);
        const data = await response.json();
        console.log("RESPONSE DATA:", data);
        
        if (data.ok) {
          if (data.duplicate) {
            alert("Tedavi grubu zaten mevcut! Mevcut grup kullanƒ±ldƒ±.");
          } else {
            alert("Tedavi grubu ba≈üarƒ±yla olu≈üturuldu!");
          }
          
          // Redirect back to patient detail page with groups tab active
          const currentPatientId = document.getElementById("patientSelect")?.value || patientId;
          if (currentPatientId) {
            window.location.href = `/admin-patient-detail.html?patientId=${currentPatientId}&tab=groups`;
          } else {
            // Fallback to patients list if no patient ID
            window.location.href = "/admin-patients.html";
          }
        } else {
          alert("Hata: " + (data.error || "Bilinmeyen hata"));
        }
        
      } catch (error) {
        console.error("SUBMIT ERROR:", error);
        alert("Hata: " + error.message);
      } finally {
        // Always reset submission state
        isSubmitting = false;
        
        // Re-enable submit button and restore text
        const submitBtn = document.getElementById("submit-btn");
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Tedavi Grubu Olu≈ütur";
        }
        
        console.log("SUBMIT COMPLETED - STATE RESET");
      }
    }
  </script>
</body>
</html>
