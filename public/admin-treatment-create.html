<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Treatment Olu≈ütur - Clinifly Admin</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("admin_token");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root {
      --bg:#111827;
      --card:#1f2937;
      --b:#374151;
      --p:#2563eb;
      --g:#16a34a;
      --r:#dc2626;
      --y:#f59e0b;
      --muted:#a7b2c8;
      --link:#6aa6ff;
    }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#e6eaf2; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    .navbar{ background:var(--card); border-bottom:1px solid var(--b); padding:15px 30px; display:flex; justify-content:space-between; align-items:center; }
    .navbar-brand{ font-size:20px; font-weight:600; color:var(--p); }
    .navbar-center{ display:flex; gap:20px; }
    .nav-link{ color:var(--muted); text-decoration:none; padding:8px 16px; border-radius:6px; transition:all 0.2s; }
    .nav-link:hover{ background:var(--b); color:var(--p); }
    .nav-link.active{ background:var(--p); color:white; }
    .page-header{ margin:30px 0; text-align:center; }
    .page-title{ font-size:28px; font-weight:600; color:var(--p); margin-bottom:10px; }
    .page-subtitle{ color:var(--muted); font-size:16px; }
    .treatment-form{ background:var(--card); border-radius:12px; padding:30px; margin:30px 0; }
    .form-section{ margin-bottom:30px; }
    .form-section-title{ font-size:18px; font-weight:600; color:var(--p); margin-bottom:15px; display:flex; align-items:center; gap:10px; }
    .required{ color:var(--r); }
    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .form-group{ display:flex; flex-direction:column; }
    .form-label{ font-weight:500; margin-bottom:8px; color:var(--p); }
    .form-select, .form-input{ padding:12px; border:1px solid var(--b); border-radius:6px; background:var(--bg); color:var(--p); font-size:14px; }
    .form-select:focus, .form-input:focus{ outline:none; border-color:var(--p); box-shadow:0 0 0 0 2px rgba(37,99,235,0.1); }
    .multi-select{ min-height:80px; }
    .btn{ padding:12px 24px; border:none; border-radius:6px; font-weight:500; cursor:pointer; transition:all 0.2s; font-size:14px; }
    .btn-primary{ background:var(--p); color:white; }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-secondary{ background:var(--b); color:var(--p); }
    .btn-secondary:hover{ background:#4b5563; }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .btn-container{ display:flex; gap:10px; justify-content:flex-end; margin-top:30px; }
    .loading{ display:none; text-align:center; padding:20px; }
    .spinner{ border:2px solid var(--muted); border-top:2px solid var(--p); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; }
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .error{ background:#dc2626; color:white; padding:10px; border-radius:6px; margin:10px 0; }
    .success{ background:#16a34a; color:white; padding:10px; border-radius:6px; margin:10px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Navigation -->
    <div class="navbar">
      <div class="navbar-brand">Clinifly</div>
      <div class="navbar-center">
        <a href="/admin-dashboard.html" class="nav-link">Dashboard</a>
        <a href="/admin-patients.html" class="nav-link">Patients</a>
        <a href="/admin-treatment-create.html" class="nav-link active">Treatment Olu≈ütur</a>
        <a href="/admin-treatment.html" class="nav-link">Treatment</a>
        <a href="/admin-chat.html" class="nav-link" id="chatNavLink">Chat</a>
      </div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">üè• Treatment Olu≈ütur</h1>
      <p class="page-subtitle">Yeni tedavi grubu olu≈üturun ve doktor atayƒ±n</p>
    </div>

    <!-- Treatment Form -->
    <div class="treatment-form">
      <form id="treatmentForm">
        <!-- Patient Selection -->
        <div class="form-section">
          <h2 class="form-section-title">
            üßë Hasta Se√ßimi
            <span class="required">*</span>
          </h2>
          <div class="form-group">
            <label class="form-label">Hasta:</label>
            <select id="patientSelect" class="form-select" required>
              <option value="">Hasta se√ßin...</option>
            </select>
          </div>
        </div>

        <!-- Primary Doctor Selection -->
        <div class="form-section">
          <h2 class="form-section-title">
            üë®‚Äç‚öïÔ∏è Primary Doktor
            <span class="required">*</span>
          </h2>
          <div class="form-group">
            <label class="form-label">Primary Doktor:</label>
            <select id="primaryDoctorSelect" class="form-select" required>
              <option value="">Primary doktor se√ßin...</option>
            </select>
          </div>
        </div>

        <!-- Additional Doctors -->
        <div class="form-section">
          <h2 class="form-section-title">
            üë• Ek Doktorlar (ƒ∞steƒüe Baƒülƒ±)
          </h2>
          <div class="form-group">
            <label class="form-label">Ek Doktorlar:</label>
            <select id="additionalDoctorsSelect" class="form-select multi-select" multiple>
              <option value="">Ek doktor se√ßin (isteƒüe baƒülƒ±)...</option>
            </select>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="btn-container">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin-patients.html'">
            ƒ∞ptal
          </button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            üöÄ TEDAVƒ∞Yƒ∞ BA≈ûLAT
          </button>
        </div>
      </form>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Treatment grubu olu≈üturuluyor...</p>
      </div>

      <!-- Messages -->
      <div id="message"></div>
    </div>
  </div>

  <script>
    // Global variables
    let patients = [];
    let doctors = [];
    let selectedPatient = null;
    let selectedPrimaryDoctor = null;
    let selectedAdditionalDoctors = [];
    let isSubmitting = false;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadPatients();
      loadDoctors();
      setupFormHandlers();
    });

    // Load patients
    async function loadPatients() {
      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch('/api/admin/patients', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Hastalar y√ºklenemedi');
        }

        const data = await response.json();
        patients = data.patients || [];

        const patientSelect = document.getElementById('patientSelect');
        patientSelect.innerHTML = '<option value="">Hasta se√ßin...</option>';
        
        patients.forEach(patient => {
          const option = document.createElement('option');
          option.value = patient.patient_id;
          option.textContent = `${patient.name} (${patient.patient_id})`;
          patientSelect.appendChild(option);
        });

      } catch (error) {
        showMessage('Hastalar y√ºklenirken hata: ' + error.message, 'error');
      }
    }

    // Load doctors
    async function loadDoctors() {
      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch('/api/admin/doctor-applications', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Doktorlar y√ºklenemedi');
        }

        const data = await response.json();
        doctors = data.doctors || [];

        const primaryDoctorSelect = document.getElementById('primaryDoctorSelect');
        const additionalDoctorsSelect = document.getElementById('additionalDoctorsSelect');
        
        primaryDoctorSelect.innerHTML = '<option value="">Primary doktor se√ßin...</option>';
        additionalDoctorsSelect.innerHTML = '<option value="">Ek doktor se√ßin (isteƒüe baƒülƒ±)...</option>';
        
        doctors.forEach(doctor => {
          if (doctor.status === 'ACTIVE') {
            const option1 = document.createElement('option');
            option1.value = doctor.doctor_id;
            option1.textContent = `${doctor.name} (${doctor.doctor_id})`;
            primaryDoctorSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = doctor.doctor_id;
            option2.textContent = `${doctor.name} (${doctor.doctor_id})`;
            additionalDoctorsSelect.appendChild(option2);
          }
        });

      } catch (error) {
        showMessage('Doktorlar y√ºklenirken hata: ' + error.message, 'error');
      }
    }

    // Setup form handlers
    function setupFormHandlers() {
      const form = document.getElementById('treatmentForm');
      form.addEventListener('submit', handleFormSubmit);

      // Patient selection handler
      document.getElementById('patientSelect').addEventListener('change', function(e) {
        selectedPatient = patients.find(p => p.patient_id === e.target.value);
        console.log('Selected patient:', selectedPatient);
      });

      // Primary doctor selection handler
      document.getElementById('primaryDoctorSelect').addEventListener('change', function(e) {
        selectedPrimaryDoctor = doctors.find(d => d.doctor_id === e.target.value);
        console.log('Selected primary doctor:', selectedPrimaryDoctor);
      });

      // Additional doctors selection handler
      document.getElementById('additionalDoctorsSelect').addEventListener('change', function(e) {
        const selectedOptions = Array.from(e.target.selectedOptions);
        selectedAdditionalDoctors = selectedOptions.map(option => 
          doctors.find(d => d.doctor_id === option.value)
        );
        console.log('Selected additional doctors:', selectedAdditionalDoctors);
      });
    }

    // Handle form submission
    async function handleFormSubmit(e) {
      e.preventDefault();

      // Prevent double submission
      if (isSubmitting) {
        console.log('SUBMIT ALREADY IN PROGRESS - IGNORING');
        return;
      }

      isSubmitting = true;
      console.log('FORM SUBMIT STARTED');

      // Validation
      if (!selectedPatient) {
        showMessage('L√ºtfen hasta se√ßin', 'error');
        isSubmitting = false;
        return;
      }

      if (!selectedPrimaryDoctor) {
        showMessage('L√ºtfen primary doktor se√ßin', 'error');
        isSubmitting = false;
        return;
      }

      // Prepare request data - send all doctors in one request
      const allSelectedDoctors = [selectedPrimaryDoctor, ...selectedAdditionalDoctors];
      const requestData = {
        patient_id: selectedPatient.patient_id,
        primary_doctor_id: selectedPrimaryDoctor.doctor_id,
        additional_doctor_ids: selectedAdditionalDoctors.map(d => d.doctor_id)
      };

      console.log('Creating treatment group:', requestData);

      // Show loading and disable button
      document.getElementById('loading').style.display = 'block';
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('message').innerHTML = '';

      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch('/api/admin/assign-patient', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (result.ok) {
          showMessage(`‚úÖ Treatment grubu ba≈üarƒ±yla olu≈üturuldu! Group ID: ${result.treatment_group_id}`, 'success');
          
          // Redirect after 2 seconds
          setTimeout(() => {
            window.location.href = '/admin-patients.html';
          }, 2000);

        } else {
          showMessage('‚ùå Treatment grubu olu≈üturulamadƒ±: ' + result.error, 'error');
        }

      } catch (error) {
        console.error('Treatment creation error:', error);
        showMessage('‚ùå Treatment olu≈üturulurken hata: ' + error.message, 'error');
      } finally {
        // Always reset submission state
        isSubmitting = false;
        
        // Hide loading and re-enable button
        document.getElementById('loading').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
        
        console.log('SUBMIT COMPLETED - STATE RESET');
      }
    }

    // Show message
    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
      messageDiv.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
