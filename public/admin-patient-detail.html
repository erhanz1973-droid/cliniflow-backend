<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hasta Detay - Clinifly Admin</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("adminToken");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root {
      --bg:#111827;
      --card:#1f2937;
      --b:#374151;
      --p:#2563eb;
      --g:#16a34a;
      --r:#dc2626;
      --y:#f59e0b;
      --muted:#a7b2c8;
      --link:#6aa6ff;
    }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#e6eaf2; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    header{ margin-bottom:20px; border-bottom:1px solid var(--b); padding-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px; }
    h1{ font-size:24px; margin:0 0 20px; font-weight:700; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--b);
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 20px;
      color: #fff;
    }
    .nav-link {
      color: var(--muted);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .nav-link:hover {
      background: var(--card);
      color: #fff;
    }
    .nav-link.active {
      background: var(--p);
      color: #fff;
    }
    .nav-link.secondary {
      background: transparent;
      border: 1px solid var(--b);
      color: var(--muted);
    }
    .nav-link.secondary:hover {
      background: var(--card);
      color: #fff;
    }

    .patient-detail-card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--b);
    }
    .patient-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }
    .patient-info h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      color: #fff;
    }
    .patient-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .meta-item {
      background: var(--bg);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .status {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    .status.APPROVED { background: var(--g); color: #fff; }
    .status.PENDING { background: var(--y); color: #000; }
    .status.REJECTED { background: var(--r); color: #fff; }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: var(--p);
      color: #fff;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-success {
      background: var(--g);
      color: #fff;
    }
    .btn-success:hover {
      background: #15803d;
    }
    .btn-secondary {
      background: var(--card);
      color: var(--muted);
      border: 1px solid var(--b);
    }
    .btn-secondary:hover {
      background: var(--b);
      color: #fff;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .info-item {
      background: var(--bg);
      padding: 16px;
      border-radius: 8px;
    }
    .info-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 14px;
      color: #fff;
      font-weight: 600;
    }

    .treatment-groups-section {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--b);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--b);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    .modal-close:hover {
      background: var(--b);
      color: #fff;
    }
    .modal-body {
      padding: 24px;
    }
    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--b);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--b);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--p);
    }
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .doctor-selector {
      background: var(--bg);
      border: 1px solid var(--b);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .doctor-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--card);
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .doctor-item:hover {
      background: var(--b);
    }
    .doctor-item.selected {
      background: var(--p);
      color: #fff;
    }
    .doctor-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid var(--b);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .doctor-item.selected .doctor-checkbox {
      background: #fff;
      color: var(--p);
    }
    .doctor-info {
      flex: 1;
    }
    .doctor-name {
      font-weight: 600;
      color: #fff;
    }
    .doctor-meta {
      font-size: 12px;
      color: var(--muted);
    }
    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .radio-input {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--b);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .radio-item.selected .radio-input {
      background: var(--p);
      border-color: var(--p);
    }
    .radio-item.selected .radio-input::after {
      content: '';
      width: 8px;
      height: 8px;
      background: #fff;
      border-radius: 50%;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    .empty-state h3 {
      margin: 0 0 8px 0;
      color: #fff;
    }

    /* Treatment Groups Styles */
    .treatment-groups-section {
      margin-top: 24px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--b);
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: #fff;
    }
    .treatment-group-item {
      background: var(--card);
      border: 1px solid var(--b);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .group-header strong {
      font-size: 16px;
      color: #fff;
    }
    .group-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .group-status.active {
      background: var(--g);
      color: #fff;
    }
    .group-status.inactive {
      background: var(--r);
      color: #fff;
    }
    .group-details {
      display: grid;
      gap: 8px;
    }
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .detail-item .label {
      color: var(--muted);
      font-size: 14px;
    }
    .detail-item .value {
      color: #fff;
      font-size: 14px;
      font-weight: 500;
    }

    /* Tab Navigation Styles */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--b);
      margin-bottom: 24px;
      background: var(--card);
      border-radius: 8px 8px 0 0;
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 16px 24px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
    }
    .tab-btn.active {
      color: var(--p);
      background: rgba(37, 99, 235, 0.1);
      border-bottom-color: var(--p);
    }
    .tab-content {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .treatment-plan-section {
      margin-top: 24px;
    }
    .plan-actions {
      display: flex;
      gap: 12px;
    }

    /* Treatment Plan Styles */
    .treatment-plan-display {
      background: var(--card);
      border: 1px solid var(--b);
      border-radius: 8px;
      padding: 20px;
    }
    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--b);
    }
    .plan-header h4 {
      margin: 0;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
    }
    .plan-date {
      color: var(--muted);
      font-size: 12px;
    }
    .teeth-grid {
      display: grid;
      gap: 12px;
    }
    .tooth-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--b);
      border-radius: 6px;
      padding: 12px;
    }
    .tooth-header {
      margin-bottom: 8px;
      color: var(--p);
      font-weight: 600;
    }
    .treatments-list {
      display: grid;
      gap: 6px;
    }
    .treatment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }
    .treatment-name {
      color: #fff;
      font-size: 13px;
    }
    .treatment-date {
      color: var(--muted);
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="navbar">
      <div class="navbar-left">
        <div class="navbar-logo">
          üè• Clinifly Admin
        </div>
        <a href="/admin-dashboard.html" class="nav-link">Dashboard</a>
        <a href="/admin-patients.html" class="nav-link active">Hastalar</a>
        <a href="/admin-doctor-applications.html" class="nav-link">Doktorlar</a>
        <a href="/admin-treatment-groups.html" class="nav-link">Treatment Groups</a>
      </div>
      <div class="navbar-right">
        <a href="/admin-settings.html" class="nav-link secondary">Clinic Settings</a>
        <div class="lang-toggle">
          <span id="lang-tr" class="active">TR</span>
          <span>|</span>
          <span id="lang-en">EN</span>
        </div>
        <a href="#" onclick="logout(); return false;" class="nav-link secondary" style="cursor: pointer;">Logout</a>
      </div>
    </nav>

    <header>
      <div style="display: flex; align-items: center; gap: 12px;">
        <button onclick="history.back()" class="btn btn-secondary" style="padding: 8px 16px;">
          ‚Üê Geri
        </button>
        <h1>Hasta Detay</h1>
      </div>
    </header>

    <main>
      <!-- Tab Navigation -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
        <button class="tab-btn" onclick="showTab('groups')">Treatment Groups</button>
        <button class="tab-btn" onclick="showTab('plan')">Treatment Plan</button>
      </div>

      <!-- Tab Content -->
      <div id="overview" class="tab-content">
        <div class="patient-detail-card">
          <div class="patient-header">
            <div class="patient-info">
              <h2 id="patientName">Y√ºkleniyor...</h2>
              <div class="patient-meta">
                <span class="meta-item" id="patientId">ID: -</span>
                <span class="meta-item" id="patientPhone">üì± -</span>
                <span class="meta-item" id="patientEmail">üìß -</span>
                <span class="status" id="patientStatus">-</span>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn btn-success" onclick="openCreateTreatmentGroupModal()">
                ‚ûï Treatment Group Olu≈ütur
              </button>
              <button class="btn btn-primary" onclick="openAssignPatientModal()">
                üë®‚Äç‚öïÔ∏è Hasta Doktora Ata
              </button>
              <button class="btn btn-primary" onclick="openTreatment()">
                ü¶∑ Treatment
              </button>
              <button class="btn btn-secondary" onclick="openChat()">
                üí¨ Chat
              </button>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Klinik Kodu</div>
              <div class="info-value" id="clinicCode">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Kayƒ±t Tarihi</div>
              <div class="info-value" id="createdAt">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Son G√ºncelleme</div>
              <div class="info-value" id="updatedAt">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Durum</div>
              <div class="info-value" id="statusDetail">-</div>
            </div>
          </div>
        </div>
      </div>

      <div id="groups" class="tab-content" style="display:none;">
        <div class="treatment-groups-section">
          <div class="section-header">
            <h3 class="section-title">Treatment Groups</h3>
            <button class="btn btn-success" onclick="openCreateTreatmentGroupModal()">
              ‚ûï Yeni Group
            </button>
          </div>
          <div id="treatmentGroupsList">
            <div class="empty-state">
              <h3>Treatment Group Yok</h3>
              <p>Bu hasta i√ßin hen√ºz treatment group olu≈üturulmadƒ±.</p>
            </div>
          </div>
        </div>
      </div>

      <div id="plan" class="tab-content" style="display:none;">
        <div class="treatment-plan-section">
          <div class="section-header">
            <h3 class="section-title">Treatment Plan</h3>
            <div class="plan-actions">
              <button class="btn btn-primary" onclick="openTreatment()">
                ü¶∑ Treatment Planƒ± D√ºzenle
              </button>
            </div>
          </div>
          <div id="treatmentPlanContent">
            <div class="empty-state">
              <h3>Treatment Plan</h3>
              <p>Hasta tedavi planƒ± y√ºkleniyor...</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Create Treatment Group Modal -->
    <div id="createTreatmentGroupModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚ûï Treatment Group Olu≈ütur</h3>
          <button class="modal-close" onclick="closeCreateTreatmentGroupModal()">√ó</button>
        </div>
        <div class="modal-body">
          <form id="createTreatmentGroupForm">
            <div class="form-group">
              <label class="form-label">Group Adƒ± *</label>
              <input type="text" class="form-input" id="groupName" required placeholder="√ñrn: Ortodonti Tedavisi">
            </div>

            <div class="form-group">
              <label class="form-label">A√ßƒ±klama</label>
              <textarea class="form-textarea" id="groupDescription" placeholder="Treatment group a√ßƒ±klamasƒ±..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Doktor Se√ßimi *</label>
              <div id="doctorsList">
                <div class="empty-state">
                  <p>Doktorlar y√ºkleniyor...</p>
                </div>
              </div>
            </div>

            <div class="form-group" id="primaryDoctorSection" style="display: none;">
              <label class="form-label">Primary Doktor *</label>
              <div id="primaryDoctorList"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeCreateTreatmentGroupModal()">ƒ∞ptal</button>
          <button type="button" class="btn btn-success" onclick="createTreatmentGroup()">Olu≈ütur</button>
        </div>
      </div>
    </div>

    <!-- Assign Patient to Doctor Modal -->
    <div id="assignPatientModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">üë®‚Äç‚öïÔ∏è Hasta Doktora Ata</h3>
          <button class="modal-close" onclick="closeAssignPatientModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Hasta Bilgisi</h4>
            <p style="margin: 0; color: var(--muted);" id="assignPatientInfo">Y√ºkleniyor...</p>
          </div>

          <div class="form-group">
            <label class="form-label">Doktor Se√ßimi *</label>
            <div id="assignDoctorsList">
              <div class="empty-state">
                <p>Doktorlar y√ºkleniyor...</p>
              </div>
            </div>
          </div>

          <div style="background: var(--card); border: 1px solid var(--b); border-radius: 8px; padding: 16px; margin-top: 20px;">
            <h5 style="margin: 0 0 8px 0; color: #fff;">üìã Atama Kurallarƒ±</h5>
            <ul style="margin: 0; padding-left: 20px; color: var(--muted); font-size: 14px;">
              <li>Hasta i√ßin aktif treatment group yoksa otomatik olu≈üturulur</li>
              <li>Se√ßilen doktor group'a primary olarak eklenir</li>
              <li>Doktor sadece √ºyesi olduƒüu group'larda i≈ülem yapabilir</li>
              <li>Treatment plan ve encounter hastasƒ±z olu≈üturulamaz</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeAssignPatientModal()">ƒ∞ptal</button>
          <button type="button" class="btn btn-primary" onclick="assignPatientToDoctor()">Ata</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPatient = null;
    let selectedDoctors = new Set();
    let primaryDoctorId = null;
    let allDoctors = [];
    let selectedAssignDoctorId = null;

    // Get patient ID from URL
    function getPatientId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patientId');
    }

    // Load patient details
    async function loadPatientDetails() {
      const patientId = getPatientId();
      if (!patientId) {
        alert('Hasta ID bulunamadƒ±');
        window.location.href = '/admin-patients.html';
        return;
      }

      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch(`/api/admin/patients/${patientId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        if (data.ok) {
          currentPatient = data.patient;
          displayPatientDetails();
          loadTreatmentGroups();
        } else {
          throw new Error(data.error || 'Hasta y√ºklenemedi');
        }
      } catch (error) {
        console.error('Load patient error:', error);
        alert('Hasta y√ºklenemedi: ' + error.message);
        window.location.href = '/admin-patients.html';
      }
    }

    // Display patient details
    function displayPatientDetails() {
      if (!currentPatient) return;

      document.getElementById('patientName').textContent = currentPatient.name || '-';
      document.getElementById('patientId').textContent = `ID: ${currentPatient.patient_id || currentPatient.id || '-'}`;
      document.getElementById('patientPhone').textContent = `üì± ${currentPatient.phone || '-'}`;
      document.getElementById('patientEmail').textContent = `üìß ${currentPatient.email || '-'}`;
      
      const statusElement = document.getElementById('patientStatus');
      statusElement.textContent = currentPatient.status || '-';
      statusElement.className = `status ${currentPatient.status || ''}`;
      
      document.getElementById('clinicCode').textContent = currentPatient.clinic_code || '-';
      document.getElementById('createdAt').textContent = formatDate(currentPatient.created_at);
      document.getElementById('updatedAt').textContent = formatDate(currentPatient.updated_at);
      document.getElementById('statusDetail').textContent = getStatusText(currentPatient.status);
    }

    // Load treatment groups for this patient
    async function loadTreatmentGroups() {
      if (!currentPatient) return;

      const token = localStorage.getItem("admin_token");

      try {
        const res = await fetch(
          `/api/treatment-groups?patientId=${currentPatient.id}`,
          {
            headers: {
              "Authorization": `Bearer ${token}` 
            }
          }
        );

        const result = await res.json();

        if (!result.ok) {
          console.error("Failed to load groups:", result.error);
          document.getElementById('treatmentGroupsList').innerHTML = `
            <div class="empty-state">
              <h3>Treatment Groups Y√ºklenemedi</h3>
              <p>Hata: ${result.error || 'Bilinmeyen hata'}</p>
            </div>
          `;
          return;
        }

        renderGroups(result.data);
      } catch (error) {
        console.error('Load treatment groups error:', error);
        document.getElementById('treatmentGroupsList').innerHTML = `
          <div class="empty-state">
            <h3>Treatment Groups Y√ºklenemedi</h3>
            <p>Treatment groups y√ºklenirken hata olu≈ütu.</p>
          </div>
        `;
      }
    }

    // Render treatment groups
    function renderGroups(groups) {
      const container = document.getElementById("treatmentGroupsList");
      container.innerHTML = "";

      if (!groups.length) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>Treatment Group Yok</h3>
            <p>Bu hasta i√ßin hen√ºz treatment group olu≈üturulmadƒ±.</p>
          </div>
        `;
        return;
      }

      groups.forEach(group => {
        const groupElement = document.createElement("div");
        groupElement.className = "treatment-group-item";
        groupElement.innerHTML = `
          <div class="group-header">
            <strong>${group.name || 'ƒ∞simsiz Grup'}</strong>
            <span class="group-status ${group.status?.toLowerCase() || 'active'}">${group.status || 'ACTIVE'}</span>
          </div>
          <div class="group-details">
            <div class="detail-item">
              <span class="label">Primary Doctor:</span>
              <span class="value">${group.primary_doctor_id || '-'}</span>
            </div>
            <div class="detail-item">
              <span class="label">Assigned Doctors:</span>
              <span class="value">${group.doctor_ids ? group.doctor_ids.length : 0} doctor(s)</span>
            </div>
            <div class="detail-item">
              <span class="label">Created:</span>
              <span class="value">${formatDate(group.created_at)}</span>
            </div>
            ${group.description ? `
              <div class="detail-item">
                <span class="label">Description:</span>
                <span class="value">${group.description}</span>
              </div>
            ` : ''}
          </div>
        `;
        container.appendChild(groupElement);
      });
    }

    // Display treatment groups
    function displayTreatmentGroups(groups) {
      const container = document.getElementById('treatmentGroupsList');
      
      if (groups.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>Treatment Group Yok</h3>
            <p>Bu hasta i√ßin hen√ºz treatment group olu≈üturulmadƒ±.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = groups.map(group => `
        <div class="doctor-selector">
          <h4 style="margin: 0 0 8px 0; color: #fff;">${group.name}</h4>
          <p style="margin: 0 0 12px 0; color: var(--muted); font-size: 14px;">${group.description || 'A√ßƒ±klama yok'}</p>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="meta-item">üë• ${group.member_count || 0} doktor</span>
            <span class="meta-item">üìÖ ${formatDate(group.created_at)}</span>
          </div>
        </div>
      `).join('');
    }

    // Load doctors for selection
    async function loadDoctors() {
      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch('/api/admin/doctor-applications', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        allDoctors = (data.doctors || []).filter(d => d.status === 'ACTIVE');
        displayDoctors();
      } catch (error) {
        console.error('Load doctors error:', error);
        document.getElementById('doctorsList').innerHTML = `
          <div class="empty-state">
            <p>Doktorlar y√ºklenemedi</p>
          </div>
        `;
      }
    }

    // Load doctors for assignment
    async function loadAssignDoctors() {
      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch('/api/admin/doctor-applications', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        const activeDoctors = (data.doctors || []).filter(d => d.status === 'ACTIVE');
        displayAssignDoctors(activeDoctors);
      } catch (error) {
        console.error('Load assign doctors error:', error);
        document.getElementById('assignDoctorsList').innerHTML = `
          <div class="empty-state">
            <p>Doktorlar y√ºklenemedi</p>
          </div>
        `;
      }
    }

    // Display doctors for selection
    function displayDoctors() {
      const container = document.getElementById('doctorsList');
      
      if (allDoctors.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Aktif doktor bulunamadƒ±</p>
          </div>
        `;
        return;
      }

      container.innerHTML = allDoctors.map(doctor => `
        <div class="doctor-item" onclick="toggleDoctor('${doctor.id}')" data-doctor-id="${doctor.id}">
          <div class="doctor-checkbox">
            ${selectedDoctors.has(doctor.id) ? '‚úì' : ''}
          </div>
          <div class="doctor-info">
            <div class="doctor-name">${doctor.name}</div>
            <div class="doctor-meta">${doctor.department || 'Bilinmeyen'} ‚Ä¢ ${doctor.specialties || 'Genel'}</div>
          </div>
        </div>
      `).join('');
    }

    // Display doctors for assignment
    function displayAssignDoctors(doctors) {
      const container = document.getElementById('assignDoctorsList');
      
      if (doctors.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Aktif doktor bulunamadƒ±</p>
          </div>
        `;
        return;
      }

      container.innerHTML = doctors.map(doctor => `
        <div class="doctor-item ${selectedAssignDoctorId === doctor.id ? 'selected' : ''}" onclick="selectAssignDoctor('${doctor.id}')" data-doctor-id="${doctor.id}">
          <div class="doctor-checkbox">
            ${selectedAssignDoctorId === doctor.id ? '‚úì' : ''}
          </div>
          <div class="doctor-info">
            <div class="doctor-name">${doctor.name}</div>
            <div class="doctor-meta">${doctor.department || 'Bilinmeyen'} ‚Ä¢ ${doctor.specialties || 'Genel'}</div>
          </div>
        </div>
      `).join('');
    }

    // Toggle doctor selection
    function toggleDoctor(doctorId) {
      if (selectedDoctors.has(doctorId)) {
        selectedDoctors.delete(doctorId);
        if (primaryDoctorId === doctorId) {
          primaryDoctorId = null;
        }
      } else {
        selectedDoctors.add(doctorId);
      }
      
      displayDoctors();
      updatePrimaryDoctorSection();
    }

    // Select doctor for assignment
    function selectAssignDoctor(doctorId) {
      selectedAssignDoctorId = doctorId;
      displayAssignDoctors(allDoctors.filter(d => d.status === 'ACTIVE'));
    }

    // Update primary doctor section
    function updatePrimaryDoctorSection() {
      const section = document.getElementById('primaryDoctorSection');
      const container = document.getElementById('primaryDoctorList');
      
      if (selectedDoctors.size === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      const selectedDoctorsList = allDoctors.filter(d => selectedDoctors.has(d.id));
      
      container.innerHTML = selectedDoctorsList.map(doctor => `
        <div class="radio-item ${primaryDoctorId === doctor.id ? 'selected' : ''}" onclick="setPrimaryDoctor('${doctor.id}')">
          <div class="radio-input"></div>
          <div>${doctor.name} - ${doctor.department || 'Bilinmeyen'}</div>
        </div>
      `).join('');
    }

    // Set primary doctor
    function setPrimaryDoctor(doctorId) {
      primaryDoctorId = doctorId;
      updatePrimaryDoctorSection();
    }

    // Open create treatment group modal
    function openCreateTreatmentGroupModal() {
      document.getElementById('createTreatmentGroupModal').classList.add('show');
      loadDoctors();
    }

    // Close create treatment group modal
    function closeCreateTreatmentGroupModal() {
      document.getElementById('createTreatmentGroupModal').classList.remove('show');
      // Reset form
      document.getElementById('createTreatmentGroupForm').reset();
      selectedDoctors.clear();
      primaryDoctorId = null;
      updatePrimaryDoctorSection();
    }

    // Open assign patient modal
    function openAssignPatientModal() {
      if (!currentPatient) return;
      
      document.getElementById('assignPatientInfo').textContent = 
        `${currentPatient.name} (${currentPatient.patient_id}) - ${currentPatient.phone || 'No phone'}`;
      
      document.getElementById('assignPatientModal').classList.add('show');
      loadAssignDoctors();
    }

    // Close assign patient modal
    function closeAssignPatientModal() {
      document.getElementById('assignPatientModal').classList.remove('show');
      selectedAssignDoctorId = null;
    }

    // Assign patient to doctor
    async function assignPatientToDoctor() {
      if (!selectedAssignDoctorId) {
        alert('Doktor se√ßmelisiniz');
        return;
      }

      if (!currentPatient) {
        alert('Hasta bilgisi bulunamadƒ±');
        return;
      }

      try {
        const token = localStorage.getItem('admin_token');
        
        const response = await fetch('/api/admin/assign-patient', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            patientId: currentPatient.patient_id,
            doctorId: selectedAssignDoctorId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || 'Atama ba≈üarƒ±sƒ±z');
        }

        const assignmentType = data.data.assignmentType;
        const groupName = data.data.treatmentGroup.name;
        
        alert(`Hasta ba≈üarƒ±yla doktora atandƒ±!\n\n${assignmentType === 'new_group' ? 'Yeni Treatment Group olu≈üturuldu: ' + groupName : 'Mevcut Treatment Group kullanƒ±ldƒ±: ' + groupName}`);
        
        closeAssignPatientModal();
        loadTreatmentGroups();
        
      } catch (error) {
        console.error('Assign patient error:', error);
        alert('Hasta atama ba≈üarƒ±sƒ±z: ' + error.message);
      }
    }

    // Create treatment group
    async function createTreatmentGroup() {
      const groupName = document.getElementById('groupName').value.trim();
      const groupDescription = document.getElementById('groupDescription').value.trim();

      if (!groupName) {
        alert('Group adƒ± zorunludur');
        return;
      }

      if (selectedDoctors.size === 0) {
        alert('En az bir doktor se√ßmelisiniz');
        return;
      }

      if (!primaryDoctorId) {
        alert('Primary doktor se√ßmelisiniz');
        return;
      }

      try {
        const token = localStorage.getItem('admin_token');
        
        // Create treatment group
        const groupResponse = await fetch('/api/treatment-groups', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: groupName,
            description: groupDescription,
            clinicId: currentPatient.clinic_id
          })
        });

        if (!groupResponse.ok) {
          throw new Error(`HTTP ${groupResponse.status}`);
        }

        const groupData = await groupResponse.json();
        if (!groupData.ok) {
          throw new Error(groupData.error || 'Group olu≈üturulamadƒ±');
        }

        const groupId = groupData.group.id;

        // Add doctors to group
        for (const doctorId of selectedDoctors) {
          const memberResponse = await fetch('/api/treatment-groups/members', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              groupId,
              doctorId,
              isPrimary: doctorId === primaryDoctorId
            })
          });

          if (!memberResponse.ok) {
            console.error(`Failed to add doctor ${doctorId} to group`);
          }
        }

        // Assign patient to group
        const assignmentResponse = await fetch('/api/patient-group-assignments', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            groupId,
            patientId: currentPatient.id
          })
        });

        if (!assignmentResponse.ok) {
          console.error('Failed to assign patient to group');
        }

        alert('Treatment Group ba≈üarƒ±yla olu≈üturuldu!');
        closeCreateTreatmentGroupModal();
        loadTreatmentGroups();
        
      } catch (error) {
        console.error('Create treatment group error:', error);
        alert('Treatment Group olu≈üturulamadƒ±: ' + error.message);
      }
    }

    // Utility functions
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    }

    function getStatusText(status) {
      const statusMap = {
        'PENDING': 'Onay Bekliyor',
        'APPROVED': 'Onaylƒ±',
        'ACTIVE': 'Aktif',
        'REJECTED': 'Reddedildi'
      };
      return statusMap[status] || status;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function logout() {
      localStorage.removeItem('admin_token');
      window.location.href = '/admin-login.html';
    }

    function openTreatment() {
      if (currentPatient) {
        window.open(`/treatment.html?patientId=${currentPatient.id}`, '_blank');
      }
    }

    function openChat() {
      if (currentPatient) {
        window.open(`/chat.html?patientId=${currentPatient.id}`, '_blank');
      }
    }

    // Tab switching with lazy loading
    function showTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll(".tab-content").forEach(el => {
        el.style.display = "none";
      });

      // Remove active class from all tab buttons
      document.querySelectorAll(".tab-btn").forEach(el => {
        el.classList.remove("active");
      });

      // Show selected tab content
      document.getElementById(tabId).style.display = "block";

      // Add active class to selected tab button
      event.target.classList.add("active");

      // Lazy load data based on tab
      if (tabId === "groups" && currentPatient) {
        loadTreatmentGroups();
      }

      if (tabId === "plan" && currentPatient) {
        loadTreatmentPlan();
      }
    }

    // Load treatment plan for patient
    async function loadTreatmentPlan() {
      if (!currentPatient) return;

      const token = localStorage.getItem("admin_token");
      const planContainer = document.getElementById("treatmentPlanContent");

      try {
        const res = await fetch(
          `/api/patient/${currentPatient.id}/treatments`,
          {
            headers: {
              "Authorization": `Bearer ${token}` 
            }
          }
        );

        const result = await res.json();

        if (!result.ok) {
          console.error("Failed to load treatment plan:", result.error);
          planContainer.innerHTML = `
            <div class="empty-state">
              <h3>Treatment Plan Y√ºklenemedi</h3>
              <p>Hata: ${result.error || 'Bilinmeyen hata'}</p>
            </div>
          `;
          return;
        }

        renderTreatmentPlan(result.data);
      } catch (error) {
        console.error('Load treatment plan error:', error);
        planContainer.innerHTML = `
          <div class="empty-state">
            <h3>Treatment Plan Y√ºklenemedi</h3>
            <p>Treatment plan y√ºklenirken hata olu≈ütu.</p>
          </div>
        `;
      }
    }

    // Render treatment plan
    function renderTreatmentPlan(plan) {
      const container = document.getElementById("treatmentPlanContent");
      
      if (!plan || !plan.teeth || Object.keys(plan.teeth).length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>Treatment Plan</h3>
            <p>Bu hasta i√ßin hen√ºz tedavi planƒ± olu≈üturulmadƒ±.</p>
            <button class="btn btn-primary" onclick="openTreatment()">
              ü¶∑ Treatment Plan Olu≈ütur
            </button>
          </div>
        `;
        return;
      }

      // Simple treatment plan display
      const teethHtml = Object.entries(plan.teeth).map(([toothId, treatments]) => `
        <div class="tooth-item">
          <div class="tooth-header">
            <strong>Di≈ü ${toothId}</strong>
          </div>
          <div class="treatments-list">
            ${treatments.map(treatment => `
              <div class="treatment-item">
                <span class="treatment-name">${treatment.procedure || 'ƒ∞simsiz Tedavi'}</span>
                <span class="treatment-date">${formatDate(treatment.date)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      container.innerHTML = `
        <div class="treatment-plan-display">
          <div class="plan-header">
            <h4>Tedavi Planƒ±</h4>
            <span class="plan-date">Son g√ºncelleme: ${formatDate(plan.updatedAt)}</span>
          </div>
          <div class="teeth-grid">
            ${teethHtml}
          </div>
        </div>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadPatientDetails();
      
      // Check for tab parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');
      if (tabParam && ['overview', 'groups', 'plan'].includes(tabParam)) {
        // Wait a bit for patient data to load, then switch tab
        setTimeout(() => {
          // Find and click the appropriate tab button
          const tabButtons = document.querySelectorAll('.tab-btn');
          tabButtons.forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(`'${tabParam}'`)) {
              btn.click();
            }
          });
        }, 500);
      }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('createTreatmentGroupModal');
      if (event.target === modal) {
        closeCreateTreatmentGroupModal();
      }
    }
  </script>
</body>
</html>
