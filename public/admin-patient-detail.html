<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hasta Detay - Clinifly Admin</title>

<script>
(function(){
  const token = localStorage.getItem("adminToken");
  if(!token) window.location.href="/admin-login.html";
})();
</script>

<style>
body{font-family:sans-serif;background:#111827;color:#fff;margin:0;padding:20px}
.tabs{display:flex;gap:10px;margin-bottom:20px}
.tab-btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;background:#1f2937;color:#ccc}
.tab-btn.active{background:#2563eb;color:white}
.tab-content{display:none}
.tab-content.active{display:block}
.card{background:#1f2937;padding:20px;border-radius:8px;margin-bottom:15px}
.btn{padding:10px 16px;border:none;border-radius:6px;cursor:pointer}
.btn-success{background:#16a34a;color:white}
.btn-secondary{background:#374151;color:white}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-content{background:#1f2937;padding:20px;border-radius:10px;width:400px}
input{width:100%;padding:10px;border-radius:6px;border:1px solid #374151;background:#111827;color:white}
</style>
</head>

<body>

<h2 id="patientName">Yükleniyor...</h2>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('overview',this)">Overview</button>
  <button class="tab-btn" onclick="switchTab('groups',this)">Treatment Groups</button>
  <button class="tab-btn" onclick="switchTab('plan',this)">Treatment Plan</button>
</div>

<div id="overview" class="tab-content active">
  <div class="card">
    <p><strong>ID:</strong> <span id="patientId"></span></p>
    <p><strong>Telefon:</strong> <span id="patientPhone"></span></p>
    <p><strong>Email:</strong> <span id="patientEmail"></span></p>
  </div>
</div>

<div id="groups" class="tab-content">
  <button class="btn btn-success" onclick="openModal()">➕ Yeni Treatment Group</button>
  <div id="groupsContainer" style="margin-top:20px;"></div>
</div>

<div id="plan" class="tab-content">
  <div class="card">
    <p>Treatment plan burada yüklenecek.</p>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Treatment Group Oluştur</h3>
    <p>Grup adı otomatik oluşturulacaktır:</p>
    <input id="groupName" readonly />
    <br><br>
    <button class="btn btn-success" onclick="createGroup()">Oluştur</button>
    <button class="btn btn-secondary" onclick="closeModal()">İptal</button>
  </div>
</div>

<script>

let currentPatient = null;

function getToken(){
  return localStorage.getItem("adminToken") || "";
}

function getPatientId(){
  return new URLSearchParams(window.location.search).get("patientId");
}

function switchTab(tabId,btn){
  document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  btn.classList.add("active");

  if(tabId==="groups") loadGroups();
}

/* ---------------- LOAD PATIENT ---------------- */

async function loadPatient(){
  const id = getPatientId();
  if(!id) return;

  const res = await fetch(`/api/admin/patients/${id}`,{
    headers:{Authorization:`Bearer ${getToken()}`}
  });

  const data = await res.json();
  if(!data.ok) return;

  currentPatient = data.patient;

  document.getElementById("patientName").textContent = currentPatient.name;
  document.getElementById("patientId").textContent = currentPatient.id;
  document.getElementById("patientPhone").textContent = currentPatient.phone || "-";
  document.getElementById("patientEmail").textContent = currentPatient.email || "-";
}

/* ---------------- LOAD GROUPS ---------------- */

async function loadGroups(){
  if(!currentPatient) return;

  const res = await fetch(
    `/api/admin/treatment-groups?patient_id=${currentPatient.id}`,
    {headers:{Authorization:`Bearer ${getToken()}`}}
  );

  const data = await res.json();
  const container = document.getElementById("groupsContainer");
  container.innerHTML="";

  if(!data.ok || !data.data.length){
    container.innerHTML="<p>Henüz group yok.</p>";
    return;
  }

  data.data.forEach(g=>{
    container.innerHTML+=`
      <div class="card">
        <strong>${g.group_name}</strong><br>
        ${new Date(g.created_at).toLocaleString("tr-TR")}
      </div>
    `;
  });
}

/* ---------------- MODAL ---------------- */

async function openModal(){
  document.getElementById("modal").classList.add("show");

  const res = await fetch(
    `/api/admin/treatment-groups?patient_id=${currentPatient.id}`,
    {headers:{Authorization:`Bearer ${getToken()}`}}
  );

  const data = await res.json();
  const count = data.ok ? data.data.length : 0;

  document.getElementById("groupName").value =
    `${currentPatient.name} ${count+1}`;
}

function closeModal(){
  document.getElementById("modal").classList.remove("show");
}

/* ---------------- CREATE GROUP ---------------- */

async function createGroup(){
  const res = await fetch("/api/admin/treatment-groups",{
    method:"POST",
    headers:{
      Authorization:`Bearer ${getToken()}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      patient_id: currentPatient.id
    })
  });

  const data = await res.json();

  if(!res.ok || !data.ok){
    alert(data.error || "Oluşturulamadı");
    return;
  }

  alert("Treatment Group oluşturuldu");
  closeModal();
  loadGroups();
}

/* ---------------- INIT ---------------- */

document.addEventListener("DOMContentLoaded",loadPatient);

</script>

</body>
</html>
