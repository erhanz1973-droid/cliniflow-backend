<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chat - Clinifly</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 16px;
      border-bottom: 1px solid #1f2937;
      background: #0b1220;
      flex-shrink: 0;
    }
    
    .chat-header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }
    
    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .message.from-CLINIC {
      background: #2563eb;
      color: #fff;
      align-self: flex-start;
    }
    
    .message.from-PATIENT {
      background: #1f2937;
      color: #e6eaf2;
      align-self: flex-end;
    }
    
    .message-time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 4px;
    }
    
    .chat-input-area {
      padding: 16px;
      border-top: 1px solid #1f2937;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #1f2937;
      border-radius: 8px;
      font-size: 14px;
      background: #1f2937;
      color: #e6eaf2;
    }
    
    button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: opacity 0.2s;
      background: #2563eb;
      color: #fff;
    }
    
    button:active {
      opacity: 0.7;
    }
    
    .camera-cta-btn {
      background: #16a34a;
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      transition: opacity 0.2s;
    }
    
    .camera-cta-btn:active {
      opacity: 0.7;
    }
    
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    a {
      color: inherit;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="chat-header">
    <h1>Klinik ile Sohbet</h1>
  </div>
  
  <div id="chatMessages" class="chat-messages">
    <div class="empty">
      <div class="empty-icon">ðŸ’¬</div>
      <div>Mesajlar yÃ¼kleniyor...</div>
    </div>
  </div>
  
  <div class="chat-input-area">
    <input type="text" id="messageInput" class="chat-input" placeholder="Mesaj yazÄ±n..." />
    <button onclick="sendMessage()">GÃ¶nder</button>
  </div>

  <script>
    // Get patient ID from URL or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    let patientId = urlParams.get('patientId') || localStorage.getItem('patient_id') || localStorage.getItem('patientId');
    
    console.log('[CHAT INIT] Patient ID:', patientId, 'from URL:', urlParams.get('patientId'), 'from localStorage:', localStorage.getItem('patient_id') || localStorage.getItem('patientId'));
    
    if (!patientId) {
      document.getElementById('chatMessages').innerHTML = '<div class="empty"><div>Hasta ID bulunamadÄ±</div></div>';
    }
    
    // Get token from localStorage or URL
    const token = localStorage.getItem('patient_token') || urlParams.get('token') || '';
    const API_BASE = window.location.origin;
    
    // Check for success message from camera
    if (urlParams.get('message')) {
      const message = urlParams.get('message');
      setTimeout(() => {
        alert(message);
        // Remove message from URL
        const newUrl = window.location.pathname + '?patientId=' + encodeURIComponent(patientId);
        window.history.replaceState({}, '', newUrl);
      }, 500);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function loadMessages() {
      if (!patientId) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/patient/${encodeURIComponent(patientId)}/messages`, {
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Accept': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const json = await res.json();
        if (!json.ok) {
          throw new Error(json.error || 'Mesajlar yÃ¼klenemedi');
        }
        
        const messages = Array.isArray(json.messages) ? json.messages : [];
        renderMessages(messages);
      } catch (error) {
        console.error('Load messages error:', error);
        document.getElementById('chatMessages').innerHTML = '<div class="empty"><div>Mesajlar yÃ¼klenemedi</div></div>';
      }
    }
    
    function renderMessages(messages) {
      const container = document.getElementById('chatMessages');
      if (messages.length === 0) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ’¬</div><div>HenÃ¼z mesaj yok</div></div>';
        return;
      }
      
      console.log('[CHAT RENDER] Total messages:', messages.length, 'Patient ID:', patientId);
      
      // Find the index of the last CLINIC message
      let lastClinicIndex = -1;
      for (let i = messages.length - 1; i >= 0; i--) {
        if ((messages[i].from || 'CLINIC') === 'CLINIC') {
          lastClinicIndex = i;
          break;
        }
      }
      
      console.log('[CHAT RENDER] Last CLINIC message index:', lastClinicIndex);
      
      container.innerHTML = messages.map((msg, index) => {
        const from = msg.from || 'CLINIC';
        const text = msg.text || '';
        const time = msg.createdAt ? new Date(msg.createdAt).toLocaleString('tr-TR') : '';
        const attachment = msg.attachment || null;
        const type = String(msg.type || (attachment?.fileType || "text")).toLowerCase();
        
        let attachmentHtml = '';
        if (attachment && (type === 'image' || attachment.fileType === 'image')) {
          const url = escapeHtml(attachment.url || '');
          const name = escapeHtml(attachment.name || 'FotoÄŸraf');
          console.log('[CHAT RENDER] Message with attachment:', { attachmentType: 'image', id: msg.id || '', mimeType: attachment.mimeType || '', name: name, type: type, url: url });
          attachmentHtml = `
            <div style="margin-top:8px;">
              <img src="${url}" alt="${name}" />
            </div>
          `;
        } else if (attachment) {
          const url = escapeHtml(attachment.url || '');
          const name = escapeHtml(attachment.name || 'Dosya');
          console.log('[CHAT RENDER] Message with attachment:', { attachmentType: 'file', id: msg.id || '', mimeType: attachment.mimeType || '', name: name, type: type, url: url });
          attachmentHtml = `
            <div style="margin-top:8px;">
              <a href="${url}" target="_blank" rel="noopener">ðŸ“Ž ${name}</a>
            </div>
          `;
        }
        
        // Add CTA button for CLINIC messages (show only on last CLINIC message)
        let ctaButton = '';
        console.log('[CHAT RENDER] Message:', { from, index, lastClinicIndex, patientId, isCLINIC: from === 'CLINIC', shouldShowCTA: from === 'CLINIC' && patientId && index === lastClinicIndex });
        if (from === 'CLINIC' && patientId && index === lastClinicIndex) {
          const cameraUrl = `/intraoral-camera.html?patientId=${encodeURIComponent(patientId)}&chatId=${encodeURIComponent(patientId)}`;
          console.log('[CHAT RENDER] Adding CTA button for CLINIC message at index', index);
          ctaButton = `
            <button class="camera-cta-btn" onclick="window.open('${cameraUrl}', '_blank')">
              ðŸ“· Kamerayla FotoÄŸraf Ã‡ek
            </button>
          `;
        }
        
        return `
          <div class="message from-${from}">
            ${text ? `<div>${escapeHtml(text)}</div>` : ''}
            ${attachmentHtml}
            ${ctaButton}
            ${time ? `<div class="message-time">${escapeHtml(time)}</div>` : ''}
          </div>
        `;
      }).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text || !patientId) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/patient/${encodeURIComponent(patientId)}/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
          },
          body: JSON.stringify({
            text: text,
            from: 'PATIENT'
          })
        });
        
        const json = await res.json();
        if (json.ok) {
          input.value = '';
          loadMessages();
        } else {
          alert('Mesaj gÃ¶nderilemedi: ' + (json.error || 'Bilinmeyen hata'));
        }
      } catch (error) {
        console.error('Send message error:', error);
        alert('Mesaj gÃ¶nderilemedi');
      }
    }
    
    // Enter key to send
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Auto-refresh messages every 3 seconds
    setInterval(loadMessages, 3000);
    
    // Load messages on page load
    loadMessages();
  </script>
</body>
</html>
