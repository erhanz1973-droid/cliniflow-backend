<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clinifly Admin ‚Äì Referrals</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("admin_token");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root { 
      --bg:#111827; 
      --card:#1f2937; 
      --b:#374151; 
      --p:#2563eb; 
      --g:#16a34a; 
      --r:#dc2626;
      --warn:#f59e0b;
      --muted:#a7b2c8;
    }
    body{ 
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; 
      margin:0; 
      background:var(--bg); 
      color:#e6eaf2; 
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    h1{ font-size:24px; margin:0 0 20px; font-weight:700; }
    h2{ font-size:18px; margin:20px 0 12px; font-weight:600; }
    .card{ 
      background:var(--card); 
      border:0.5px solid rgba(55, 65, 81, 0.5); 
      border-radius:16px; 
      padding:24px; 
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.05); 
      margin-bottom:16px;
    }
    .nav{
      display:flex;
      gap:12px;
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .nav a{
      color:#6aa6ff;
      text-decoration:none;
      font-weight:600;
      padding:8px 16px;
      border-radius:8px;
      border:1px solid #334155;
      background:var(--card);
      transition:all 0.2s;
      font-size:14px;
      position:relative;
    }
    .nav a:hover{
      background:#1a2640;
      border-color:#6aa6ff;
      color:#8bb5ff;
    }
    .nav a.active{
      background:#2563eb;
      border-color:#2563eb;
      color:#fff;
    }
    .nav-badge{
      position:absolute;
      top:-4px;
      right:-4px;
      background:var(--r);
      color:#fff;
      border-radius:10px;
      min-width:18px;
      height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:700;
      padding:0 4px;
      border:2px solid var(--bg);
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    label{ font-size:12px; color:#e6eaf2; display:block; margin-bottom:6px; font-weight:600; }
    input, select, button{
      font-size:14px; padding:10px 12px; border-radius:8px; border:1px solid var(--b); background:#1f2937; color:#e6eaf2;
    }
    button{ 
      cursor:pointer; 
      border:none; 
      background:var(--p); 
      color:#fff; 
      font-weight:600; 
      transition:background 0.2s;
    }
    button:hover{ background:#1d4ed8; }
    button.secondary{ background:#6b7280; }
    button.secondary:hover{ background:#4b5563; }
    button.success{ background:var(--g); }
    button.success:hover{ background:#15803d; }
    button.danger{ background:var(--r); }
    button.danger:hover{ background:#b91c1c; }
    .list{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .item{ 
      border:1px solid var(--b); 
      border-radius:10px; 
      padding:16px; 
      display:flex; 
      justify-content:space-between; 
      gap:12px; 
      align-items:start; 
      background:#0b1220;
      transition:background 0.2s;
    }
    .item:hover{
      background:var(--bg);
    }
    .item-left{ flex:1; }
    .item-title{ 
      font-size:15px; 
      font-weight:600; 
      margin-bottom:8px;
      color:#e6eaf2;
    }
    .item-meta{ 
      color:var(--muted); 
      font-size:13px; 
      margin-top:4px;
      line-height:1.6;
    }
    .status{ 
      font-weight:700; 
      font-size:11px; 
      padding:4px 10px; 
      border-radius:999px; 
      border:1px solid var(--b);
      text-transform:uppercase;
      white-space:nowrap;
    }
    .status.pending{ background:#fef3c7; border-color:#fde68a; color:#92400e; }
    .status.approved{ background:#dcfce7; border-color:#86efac; color:#166534; }
    .status.rejected{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .muted{ color:var(--muted); font-size:13px; }
    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:#9ca3af;
    }
    .empty-state-icon{
      font-size:48px;
      margin-bottom:12px;
    }
    .loading{
      text-align:center;
      padding:20px;
      color:var(--muted);
    }
    .err{ color:var(--r); font-weight:700; }
    .okmsg{ color:var(--g); font-weight:700; }
    .token-section{
      background:#0b1220;
      border:1px solid var(--b);
      border-radius:8px;
      padding:12px;
      margin-bottom:16px;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--b);
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navbar-logo img {
      height: 32px;
      width: auto;
    }
    .navbar-logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--p);
      display: none; /* Hide text, show logo only */
    }
    .navbar-clinic-name {
      font-size: 14px;
      color: var(--muted);
      font-weight: 500;
    }
    .navbar-center {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
      justify-content: center;
    }
    .navbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .nav-link {
      color: var(--muted);
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      position: relative;
      transition: all 0.2s;
    }
    .nav-link:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--p);
    }
    .nav-link.active {
      background: rgba(37, 99, 235, 0.2);
      color: var(--p);
    }
    .nav-link.secondary {
      color: var(--muted);
    }
    .lang-toggle {
      display: flex;
      gap: 4px;
      align-items: center;
      color: var(--muted);
      font-size: 14px;
    }
    .lang-toggle span.active {
      color: var(--p);
      font-weight: 600;
    }
    .nav-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--r);
      color: #fff;
      border-radius: 10px;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      padding: 0 4px;
      border: 2px solid var(--bg);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 data-i18n="referrals.title">üéÅ Clinifly Admin ‚Äì Referrals</h1>
    
    <nav class="navbar">
      <div class="navbar-left">
        <div class="navbar-logo">
          <img src="/logo.svg" alt="Clinifly" />
          <span class="navbar-logo-text">Clinifly</span>
        </div>
        <div class="navbar-clinic-name" id="navbarClinicName">Clinic</div>
      </div>
      <div class="navbar-center">
        <a href="/admin.html" class="nav-link" data-i18n="dashboard.nav.dashboard">Dashboard</a>
        <a href="/admin-patients.html" class="nav-link" id="patientsNavLink" data-i18n="dashboard.nav.patients">
          Patients
          <span id="patientsBadge" class="nav-badge" style="display:none;"></span>
        </a>
        <a href="/admin-treatment.html" class="nav-link" data-i18n="dashboard.nav.treatment">Treatment</a>
        <a href="/admin-chat.html" class="nav-link" id="chatNavLink" data-i18n="dashboard.nav.chat">
          Chat
          <span id="chatBadge" class="nav-badge" style="display:none;"></span>
        </a>
      </div>
      <div class="navbar-right">
        <a href="/admin-settings.html" class="nav-link secondary" data-i18n="dashboard.nav.settings">Clinic Settings</a>
        <div class="lang-toggle">
          <span id="lang-tr" onclick="if(window.onLanguageChange) window.onLanguageChange('tr')" class="active">TR</span>
          <span>|</span>
          <span id="lang-en" onclick="if(window.onLanguageChange) window.onLanguageChange('en')">EN</span>
        </div>
        <a href="#" onclick="logout(); return false;" class="nav-link secondary" data-i18n="dashboard.nav.logout" style="cursor: pointer;">Logout</a>
    </div>
    </nav>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0;" data-i18n="referrals.referrals">Referrals</h2>
        <div class="row" style="margin:0;">
          <select id="statusFilter">
            <option value="" data-i18n="referrals.filterAll">T√ºm√º</option>
            <option value="PENDING" data-i18n="referrals.status.PENDING">Pending</option>
            <option value="APPROVED" data-i18n="referrals.status.APPROVED">Approved</option>
            <option value="REJECTED" data-i18n="referrals.status.REJECTED">Rejected</option>
          </select>
          <button onclick="loadReferrals()" data-i18n="referrals.refresh">Yenile</button>
        </div>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
      <div id="referralsList" class="loading" data-i18n="referrals.loading">Y√ºkleniyor...</div>
    </div>
  </div>

<script>
  // Nav: if a patient is selected, make top-nav Travel link carry patientId.
  (function bindNavTravelLink() {
    try {
      const pid = String(localStorage.getItem("selected_patient_id") || "").trim();
      if (!pid) return;
      const a = document.querySelector('.nav a[href="/admin-travel.html"]');
      if (a) a.href = `/admin-travel.html?patientId=${encodeURIComponent(pid)}`;
    } catch {}
  })();

  const API = "https://cliniflow-admin.onrender.com";

  function getAdminToken(){
    // localStorage'dan al
    const savedToken = localStorage.getItem('admin_token');
    if (savedToken && savedToken.trim()) {
      return savedToken.trim();
    }
    return '';
  }
  function logout() {
    try {
      localStorage.removeItem("admin_token");
      console.log("[LOGOUT] Admin token cleared");
    } catch (e) {
      console.error("[LOGOUT] Error clearing token:", e);
    }
    window.location.href = "/admin-login.html";
  }

  function setMsg(text, kind="muted"){
    const el = document.getElementById('msg');
    el.className = kind === "ok" ? "okmsg" : (kind==="err" ? "err" : "muted");
    el.textContent = text || "";
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function adminHeaders(extra = {}) {
    const token = getAdminToken();
    return {
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
      ...extra,
    };
  }

  let defaultInviterPercent = null;
  let defaultInvitedPercent = null;

  async function loadReferralDefaults() {
    const adminToken = getAdminToken();
    if (!adminToken) {
      console.warn("No admin token found for loading referral defaults");
      return;
    }
    try {
      const headers = {};
      headers["Authorization"] = adminToken.startsWith("Bearer ") ? adminToken : `Bearer ${adminToken}`;
      console.log("Loading clinic data from:", `${API}/api/admin/clinic`);
      const res = await fetch(`${API}/api/admin/clinic`, { headers });
      if (!res.ok) {
        console.error("Failed to load clinic data:", res.status, res.statusText);
        return;
      }
      const clinic = await res.json();
      console.log("Clinic data from API:", clinic); // Debug: Log the full clinic structure
      
      // Parse settings if it's a string (as shown in Supabase data)
      let parsedSettings = clinic.settings;
      if (typeof clinic.settings === 'string') {
        try {
          parsedSettings = JSON.parse(clinic.settings);
          console.log("Parsed clinic.settings:", parsedSettings);
        } catch (e) {
          console.warn("Failed to parse clinic.settings as JSON:", e);
          parsedSettings = {};
        }
      }
      
      // Debug: Explore all possible paths for referral settings
      console.log("Checking all possible referral paths:");
      console.log("parsedSettings:", parsedSettings);
      console.log("parsedSettings?.referralLevel1Percent:", parsedSettings?.referralLevel1Percent);
      console.log("parsedSettings?.referralLevels:", parsedSettings?.referralLevels);
      console.log("clinic.referralLevels:", clinic.referralLevels);
      console.log("clinic.defaultInviterDiscountPercent:", clinic.defaultInviterDiscountPercent);
      console.log("clinic.defaultInvitedDiscountPercent:", clinic.defaultInvitedDiscountPercent);
      
      // Log ALL properties in settings to find referral data
      console.log("All settings properties:");
      Object.keys(clinic.settings || {}).forEach(key => {
        console.log(`  ${key}:`, clinic.settings[key]);
        if (key.toLowerCase().includes('referral') || key.toLowerCase().includes('discount')) {
          console.log(`    ^ Found referral/discount related property: ${key}`);
        }
      });
      
      // Also check ALL clinic properties for referral data
      console.log("All clinic properties:");
      Object.keys(clinic || {}).forEach(key => {
        if (key.toLowerCase().includes('referral') || key.toLowerCase().includes('discount')) {
          console.log(`  Found clinic property: ${key}:`, clinic[key]);
        }
      });
      
      // Check if settings is a string that needs parsing
      if (typeof clinic.settings === 'string') {
        try {
          const parsedSettings = JSON.parse(clinic.settings);
          console.log("Parsed clinic.settings:", parsedSettings);
          console.log("Parsed settings referral paths:");
          console.log("parsedSettings.referralLevel1Percent:", parsedSettings.referralLevel1Percent);
          console.log("parsedSettings.referralLevels:", parsedSettings.referralLevels);
        } catch (e) {
          console.warn("Failed to parse clinic.settings as JSON:", e);
        }
      }
      const toNumOrNull = (v) => {
        if (v === "" || v === undefined || v === null) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };

      // Supabase clinic config is stored in settings.referralLevels / settings.referralLevel1Percent.
      // File-based clinics may still have defaultInviterDiscountPercent/defaultInvitedDiscountPercent.
      // Backend API returns default_inviter_discount_percent and default_invited_discount_percent directly.
      // Settings may be a JSON string that needs parsing.
      
      // Debug each path specifically
      console.log("Debugging extraction paths:");
      console.log("1. parsedSettings?.referralLevel1Percent:", parsedSettings?.referralLevel1Percent);
      console.log("2. parsedSettings?.referralLevels?.level1:", parsedSettings?.referralLevels?.level1);
      console.log("3. clinic?.referralLevels?.level1:", clinic?.referralLevels?.level1);
      console.log("4. clinic?.default_inviter_discount_percent:", clinic?.default_inviter_discount_percent);
      
      const level1Raw =
        parsedSettings?.referralLevel1Percent ??
        parsedSettings?.referralLevels?.level1 ??
        clinic?.referralLevels?.level1 ??
        clinic?.default_inviter_discount_percent ??
        null;
      const inviter = toNumOrNull(level1Raw);
      
      // For invited discount, check the same paths first, then fallback to invited-specific fields
      console.log("Debugging invited extraction paths:");
      console.log("1. parsedSettings?.referralLevel1Percent:", parsedSettings?.referralLevel1Percent);
      console.log("2. parsedSettings?.referralLevels?.level1:", parsedSettings?.referralLevels?.level1);
      console.log("3. clinic?.referralLevels?.level1:", clinic?.referralLevels?.level1);
      console.log("4. clinic?.default_invited_discount_percent:", clinic?.default_invited_discount_percent);
      
      const invitedLevel1Raw =
        parsedSettings?.referralLevel1Percent ??
        parsedSettings?.referralLevels?.level1 ??
        clinic?.referralLevels?.level1 ??
        clinic?.default_invited_discount_percent ??
        null;
      const invited = toNumOrNull(invitedLevel1Raw) ?? inviter;

      defaultInviterPercent = inviter;
      defaultInvitedPercent = invited;
      
      // Debug: Log the extracted values
      console.log("Extracted referral defaults:", {
        level1Raw,
        invitedLevel1Raw,
        inviter,
        invited,
        defaultInviterPercent,
        defaultInvitedPercent
      });
      
      if (defaultInviterPercent != null || defaultInvitedPercent != null) {
        const msg = window.i18n ? window.i18n.t('referrals.defaultDiscounts', { inviter: defaultInviterPercent ?? 0, invited: defaultInvitedPercent ?? 0 }) : `Varsayƒ±lan indirimler: Davet Eden %${defaultInviterPercent ?? 0}, Davet Edilen %${defaultInvitedPercent ?? 0}`;
        setMsg(msg, "ok");
      } else {
        // Fallback: if no discount data found, use values that comply with backend validation (0-50)
        console.warn("No discount data found in clinic settings, using fallback values");
        defaultInviterPercent = 25; // Within 0-50 range as required by backend
        defaultInvitedPercent = 25; // Same as inviter for now
        const msg = window.i18n ? window.i18n.t('referrals.defaultDiscounts', { inviter: defaultInviterPercent, invited: defaultInvitedPercent }) : `Varsayƒ±lan indirimler (fallback): Davet Eden %${defaultInviterPercent}, Davet Edilen %${defaultInvitedPercent}`;
        setMsg(msg, "ok");
      }
    } catch (e) {
      console.warn("Load referral defaults error:", e);
    }
  }

  async function loadReferrals() {
    const adminToken = getAdminToken();
    if (!adminToken) {
      const msg = window.i18n ? window.i18n.t('referrals.errors.noToken') : "‚ö†Ô∏è Admin token bulunamadƒ±. L√ºtfen admin olarak giri≈ü yapƒ±n.";
      setMsg(msg, "err");
      return;
    }

    const listEl = document.getElementById('referralsList');
    listEl.className = "loading";
    const loadingText = window.i18n ? window.i18n.t('referrals.loading') : "Y√ºkleniyor...";
    listEl.textContent = loadingText;

    try {
      const statusRaw = document.getElementById('statusFilter').value;
      const status = statusRaw ? String(statusRaw).toUpperCase() : "";
      const url = status
        ? `${API}/api/admin/referrals?status=${encodeURIComponent(status)}`
        : `${API}/api/admin/referrals`;
      
      const headers = {
        "Content-Type": "application/json"
      };
      
      if (adminToken.startsWith("Bearer ")) {
        headers["Authorization"] = adminToken;
      } else {
        headers["Authorization"] = `Bearer ${adminToken}`;
      }

      const r = await fetch(url, { headers, cache: "no-store" });
      
      if (r.status === 401) {
        const msg = window.i18n ? window.i18n.t('referrals.errors.invalidToken') : "‚ùå Admin token ge√ßersiz veya s√ºresi dolmu≈ü. L√ºtfen admin token girin.";
        setMsg(msg, "err");
        listEl.className = "empty-state";
        const authError = window.i18n ? window.i18n.t('referrals.errors.invalidToken') : "Yetkilendirme hatasƒ±";
        listEl.innerHTML = `<div style="color:var(--r);">${authError}</div>`;
        return;
      }

      if (!r.ok) {
        throw new Error(`HTTP ${r.status}`);
      }

      const data = await r.json();
      const items = data.items || [];

      if (items.length === 0) {
        listEl.className = "empty-state";
        const noReferralsText = window.i18n ? window.i18n.t('referrals.noReferrals') : "Referral bulunamadƒ±.";
        listEl.innerHTML = `
          <div class="empty-state-icon">üì≠</div>
          <div>${noReferralsText}</div>
        `;
        setMsg("", "muted");
        return;
      }

      // Load patient names if not already in referral data
      let patientNamesMap = {};
      const allPatientIds = new Set();
      items.forEach(ref => {
        if (ref.inviterPatientId) allPatientIds.add(ref.inviterPatientId);
        if (ref.invitedPatientId) allPatientIds.add(ref.invitedPatientId);
      });

      // If patient names are not in referral data, fetch them
      if (allPatientIds.size > 0 && (!items[0]?.inviterPatientName || !items[0]?.invitedPatientName)) {
        try {
          const patientsRes = await fetch(`${API}/api/admin/patients`, {
            headers: adminHeaders({ Accept: "application/json" }),
          });
          if (patientsRes.ok) {
            const patientsData = await patientsRes.json();
            if (patientsData.ok) {
              const patients = Array.isArray(patientsData.patients) ? patientsData.patients : (Array.isArray(patientsData.list) ? patientsData.list : []);
              patients.forEach(p => {
                const displayName = p.fullName || p.name || "";
                const keys = [
                  p.id,            // UUID (common in Supabase)
                  p.patient_id,    // legacy id column (p_xxx)
                  p.patientId,     // normalized field from API
                ].filter(Boolean);
                keys.forEach((k) => {
                  const key = String(k);
                  patientNamesMap[key] = displayName ? String(displayName) : key;
                });
              });
            }
          }
        } catch (e) {
          console.warn("Failed to load patient names:", e);
        }
      }

      listEl.className = "list";
      const currentLang = window.i18n ? window.i18n.getLang() : 'tr';
      const locale = currentLang === 'en' ? 'en-US' : 'tr-TR';
      
      // Sort referrals by approval date (approved_at) or creation date (createdAt) - newest first
      items.sort((a, b) => {
        // Use approved_at for approved referrals, createdAt for others
        const dateA = a.approvedAt ? new Date(a.approvedAt) : new Date(a.createdAt || 0);
        const dateB = b.approvedAt ? new Date(b.approvedAt) : new Date(b.createdAt || 0);
        return dateB.getTime() - dateA.getTime(); // Newest first
      });
      
      listEl.innerHTML = items.map(ref => {
        const statusClass = (ref.status || "PENDING").toLowerCase();
        const statusKey = (ref.status || "PENDING").toUpperCase();
        const statusText = window.i18n ? window.i18n.t(`referrals.status.${statusKey}`) : statusKey;
        const createdAt = ref.createdAt ? new Date(ref.createdAt).toLocaleString(locale) : "‚Äî";
        
        // Get patient names
        const inviterId = ref.inviterPatientId ? String(ref.inviterPatientId) : "";
        const invitedId = ref.invitedPatientId ? String(ref.invitedPatientId) : "";
        const inviterName = ref.inviterPatientName || patientNamesMap[inviterId] || inviterId || "‚Äî";
        const invitedName = ref.invitedPatientName || patientNamesMap[invitedId] || invitedId || "‚Äî";
        // Show names directly; fall back to id only if no name available.
        const inviterDisplay = inviterId ? String(inviterName || inviterId) : "‚Äî";
        const invitedDisplay = invitedId ? String(invitedName || invitedId) : "‚Äî";
        
        // Get translations
        const inviterLabel = window.i18n ? window.i18n.t('referrals.inviter') : 'Inviter';
        const invitedLabel = window.i18n ? window.i18n.t('referrals.invited') : 'Invited';
        const createdAtLabel = window.i18n ? window.i18n.t('referrals.createdAt') : 'Olu≈üturulma';
        const inviterDiscountLabel = window.i18n ? window.i18n.t('referrals.inviterDiscount') : 'Inviter ƒ∞ndirim';
        const invitedDiscountLabel = window.i18n ? window.i18n.t('referrals.invitedDiscount') : 'Invited ƒ∞ndirim';
        const discountLabel = window.i18n ? window.i18n.t('referrals.discount') : 'ƒ∞ndirim';
        const approveText = window.i18n ? window.i18n.t('referrals.approve') : 'Onayla';
        const rejectText = window.i18n ? window.i18n.t('referrals.reject') : 'Reddet';
        
        return `
          <div class="item">
            <div class="item-left">
              <div class="item-title">
                ${inviterLabel}: ${escapeHtml(inviterDisplay)} ‚Üí ${invitedLabel}: ${escapeHtml(invitedDisplay)}
              </div>
              <div class="item-meta">
                ${createdAtLabel}: ${createdAt}<br>
                ${ref.inviterDiscountPercent != null ? `${inviterDiscountLabel}: %${ref.inviterDiscountPercent} ‚Ä¢ ` : ""}
                ${ref.invitedDiscountPercent != null ? `${invitedDiscountLabel}: %${ref.invitedDiscountPercent} ‚Ä¢ ` : ""}
                ${ref.discountPercent != null ? `${discountLabel}: %${ref.discountPercent}` : ""}
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              <span class="status ${statusClass}">${statusText}</span>
              ${ref.status === "PENDING" ? `
                <div style="display:flex; gap:6px;">
                  <button class="success" onclick="approveReferral('${ref.id}')" style="font-size:12px; padding:6px 12px;">${approveText}</button>
                  <button class="danger" onclick="rejectReferral('${ref.id}')" style="font-size:12px; padding:6px 12px;">${rejectText}</button>
                </div>
              ` : ""}
            </div>
          </div>
        `;
      }).join("");

      const foundMsg = window.i18n ? window.i18n.t('referrals.found', { count: items.length }) : `${items.length} referral bulundu.`;
      setMsg(foundMsg, "ok");

    } catch (error) {
      console.error("Load referrals error:", error);
      listEl.className = "empty-state";
      const errorLabel = window.i18n ? window.i18n.t('common.error') : 'Hata';
      const loadFailedMsg = window.i18n ? window.i18n.t('referrals.errors.loadFailed') : "Referrals y√ºklenemedi.";
      listEl.innerHTML = `
        <div style="color:var(--r);">
          <strong>${errorLabel}:</strong> ${error.message || loadFailedMsg}
        </div>
      `;
      setMsg(loadFailedMsg, "err");
    }
  }

  async function approveReferral(id) {
    const adminToken = getAdminToken();
    console.log("[APPROVE] Admin token found:", !!adminToken);
    console.log("[APPROVE] Token length:", adminToken?.length);
    console.log("[APPROVE] Token starts with Bearer:", adminToken?.startsWith("Bearer "));
    
    if (!adminToken) {
      const msg = window.i18n ? window.i18n.t('referrals.errors.noToken') : "‚ùå Admin token bulunamadƒ±.";
      setMsg(msg, "err");
      return;
    }

    if (defaultInviterPercent == null && defaultInvitedPercent == null) {
      const msg = window.i18n ? window.i18n.t('referrals.defaultDiscountsRequired') : "‚ö†Ô∏è Varsayƒ±lan indirim y√ºzdeleri Clinic Settings sayfasƒ±nda girilmelidir.";
      setMsg(msg, "err");
      return;
    }

    const confirmMsg = window.i18n ? window.i18n.t('referrals.approveConfirm') : 'Bu referral\'ƒ± onaylamak istediƒüinize emin misiniz?';
    if (!confirm(confirmMsg)) {
      return;
    }

    try {
      const headers = {
        "Content-Type": "application/json"
      };
      
      if (adminToken.startsWith("Bearer ")) {
        headers["Authorization"] = adminToken;
      } else {
        headers["Authorization"] = `Bearer ${adminToken}`;
      }

      const body = {
        inviterDiscountPercent: defaultInviterPercent,
        invitedDiscountPercent: defaultInvitedPercent,
      };
      
      console.log("[APPROVE] Sending request to:", `${API}/api/admin/referrals/${id}/approve`);
      console.log("[APPROVE] Request headers:", headers);
      console.log("[APPROVE] Request body:", body);
      
      const r = await fetch(`${API}/api/admin/referrals/${id}/approve`, {
        method: "PATCH",
        headers,
        body: JSON.stringify(body)
      });

      if (!r.ok) {
        const data = await r.json();
        throw new Error(data.error || `HTTP ${r.status}`);
      }

      const successMsg = window.i18n ? window.i18n.t('referrals.approved') : "Referral onaylandƒ± ‚úÖ";
      setMsg(successMsg, "ok");
      loadReferrals();
    } catch (error) {
      console.error("Approve referral error:", error);
      const errorMsg = window.i18n ? window.i18n.t('referrals.errors.approveFailed', { error: error.message }) : `Onaylama hatasƒ±: ${error.message}`;
      setMsg(errorMsg, "err");
    }
  }

  async function rejectReferral(id) {
    const adminToken = getAdminToken();
    console.log("[REJECT] Admin token found:", !!adminToken);
    console.log("[REJECT] Token length:", adminToken?.length);
    console.log("[REJECT] Token starts with Bearer:", adminToken?.startsWith("Bearer "));
    
    if (!adminToken) {
      const msg = window.i18n ? window.i18n.t('referrals.errors.noToken') : "‚ùå Admin token bulunamadƒ±.";
      setMsg(msg, "err");
      return;
    }

    const confirmMsg = window.i18n ? window.i18n.t('referrals.rejectConfirm') : 'Bu referral\'ƒ± reddetmek istediƒüinize emin misiniz?';
    if (!confirm(confirmMsg)) {
      return;
    }

    try {
      const headers = {
        "Content-Type": "application/json"
      };
      
      if (adminToken.startsWith("Bearer ")) {
        headers["Authorization"] = adminToken;
      } else {
        headers["Authorization"] = `Bearer ${adminToken}`;
      }

      console.log("[REJECT] Sending request to:", `${API}/api/admin/referrals/${id}/reject`);
      console.log("[REJECT] Request headers:", headers);
      
      const r = await fetch(`${API}/api/admin/referrals/${id}/reject`, {
        method: "PATCH",
        headers
      });

      if (!r.ok) {
        const data = await r.json();
        throw new Error(data.error || `HTTP ${r.status}`);
      }

      const successMsg = window.i18n ? window.i18n.t('referrals.rejected') : "Referral reddedildi ‚úÖ";
      setMsg(successMsg, "ok");
      loadReferrals();
    } catch (error) {
      console.error("Reject referral error:", error);
      const errorMsg = window.i18n ? window.i18n.t('referrals.errors.rejectFailed', { error: error.message }) : `Reddetme hatasƒ±: ${error.message}`;
      setMsg(errorMsg, "err");
    }
  }

  // Status filter deƒüi≈ütiƒüinde listeyi yenile
  document.getElementById('statusFilter').addEventListener('change', loadReferrals);

  // Badge loading functions (adminHeaders already defined above)
  function adminHeaders(extra = {}) {
    const token = getAdminToken();
    return {
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
      ...extra,
    };
  }

  let previousUnreadCount = 0;
  let previousPendingPatients = 0;
  let previousPendingReferrals = 0;

  function playNotificationSound() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
      console.warn("Could not play notification sound:", e);
    }
  }

  async function loadUnreadMessageCount() {
    const token = getAdminToken();
    if (!token) return;
    try {
      let lastSeenTimestamp = 0;
      try {
        const stored = localStorage.getItem('chat_last_seen_timestamp');
        if (stored) lastSeenTimestamp = parseInt(stored, 10) || 0;
      } catch (e) {}
      const patientsRes = await fetch(`${API}/api/admin/patients`, {
        headers: adminHeaders({ Accept: "application/json" }),
      });
      if (!patientsRes.ok) return;
      const patientsData = await patientsRes.json();
      if (!patientsData.ok) return;
      const patients = Array.isArray(patientsData.patients) ? patientsData.patients : [];
      let totalUnread = 0;
      for (const patient of patients) {
        const patientId = patient.patientId || patient.id;
        if (!patientId) continue;
        try {
          const messagesRes = await fetch(`${API}/api/patient/${encodeURIComponent(patientId)}/messages`, {
            headers: adminHeaders({ Accept: "application/json" }),
          });
          if (!messagesRes.ok) continue;
          const messagesData = await messagesRes.json();
          if (!messagesData.ok) continue;
          const messages = Array.isArray(messagesData.messages) ? messagesData.messages : [];
          const unread = messages.filter((m) => {
            if (m.from !== "PATIENT") return false;
            if (m.createdAt) {
              const msgTimestamp = new Date(m.createdAt).getTime();
              return msgTimestamp > lastSeenTimestamp;
            }
            return true;
          }).length;
          totalUnread += unread;
        } catch (e) { continue; }
      }
      if (totalUnread > previousUnreadCount && previousUnreadCount > 0) {
        playNotificationSound();
      }
      previousUnreadCount = totalUnread;
      const badgeEl = document.getElementById("chatBadge");
      if (badgeEl) {
        if (totalUnread > 0) {
          badgeEl.textContent = totalUnread > 99 ? "99+" : String(totalUnread);
          badgeEl.style.display = "flex";
        } else {
          badgeEl.style.display = "none";
        }
      }
    } catch (error) {
      console.error("Load unread count error:", error);
    }
  }

  async function loadPendingPatientsCount() {
    const token = getAdminToken();
    if (!token) return;
    try {
      const res = await fetch(`${API}/api/admin/patients`, {
        headers: adminHeaders({ Accept: "application/json" }),
      });
      if (!res.ok) return;
      const data = await res.json();
      if (!data.ok) return;
      const patients = Array.isArray(data.patients) ? data.patients : (Array.isArray(data.list) ? data.list : []);
      const pendingCount = patients.filter(p => (p.status || "PENDING") === "PENDING").length;
      if (pendingCount > previousPendingPatients && previousPendingPatients > 0) {
        playNotificationSound();
      }
      previousPendingPatients = pendingCount;
      const badgeEl = document.getElementById("patientsBadge");
      if (badgeEl) {
        if (pendingCount > 0) {
          badgeEl.textContent = pendingCount > 99 ? "99+" : String(pendingCount);
          badgeEl.style.display = "flex";
        } else {
          badgeEl.style.display = "none";
        }
      }
    } catch (error) {
      console.error("Load pending patients count error:", error);
    }
  }

  async function loadPendingReferralsCount() {
    const token = getAdminToken();
    if (!token) return;
    try {
      const res = await fetch(`${API}/api/admin/referrals?status=PENDING`, {
        headers: adminHeaders({ Accept: "application/json" }),
        cache: "no-store",
      });
      if (!res.ok) return;
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      const pendingCount = items.length;
      if (pendingCount > previousPendingReferrals && previousPendingReferrals > 0) {
        playNotificationSound();
      }
      previousPendingReferrals = pendingCount;
      const badgeEl = document.getElementById("referralsBadge");
      if (badgeEl) {
        if (pendingCount > 0) {
          badgeEl.textContent = pendingCount > 99 ? "99+" : String(pendingCount);
          badgeEl.style.display = "flex";
        } else {
          badgeEl.style.display = "none";
        }
      }
    } catch (error) {
      console.error("Load pending referrals count error:", error);
    }
  }

  async function loadAllBadges() {
    await Promise.all([
      loadUnreadMessageCount(),
      loadPendingPatientsCount(),
      loadPendingReferralsCount()
    ]);
  }

  // Update UI when language changes
  window.onI18nUpdated = function(lang) {
    // Update status filter options
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter && window.i18n) {
      const allOption = statusFilter.querySelector('option[value=""]');
      const pendingOption = statusFilter.querySelector('option[value="PENDING"]');
      const approvedOption = statusFilter.querySelector('option[value="APPROVED"]');
      const rejectedOption = statusFilter.querySelector('option[value="REJECTED"]');
      if (allOption) allOption.textContent = window.i18n.t('referrals.filterAll');
      if (pendingOption) pendingOption.textContent = window.i18n.t('referrals.status.PENDING');
      if (approvedOption) approvedOption.textContent = window.i18n.t('referrals.status.APPROVED');
      if (rejectedOption) rejectedOption.textContent = window.i18n.t('referrals.status.REJECTED');
    }
    
    // Re-render referrals with new language
    const savedToken = localStorage.getItem('admin_token');
    if (savedToken && savedToken.trim()) {
      loadReferrals();
    }
  };

  // Sayfa y√ºklendiƒüinde referral'larƒ± y√ºkle
  const savedToken = localStorage.getItem('admin_token');
  if (savedToken && savedToken.trim()) {
    loadReferralDefaults();
    setTimeout(() => loadReferrals(), 300);
    loadAllBadges();
  }

  // Auto-refresh badges every 30 seconds
  setInterval(loadAllBadges, 30000);
</script>
</body>
</html>

