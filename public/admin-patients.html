<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hasta Listesi - Clinifly Admin</title>
  <script>
    // Token check - redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem("adminToken");
      if (!token) {
        window.location.href = "/admin-login.html";
      }
    })();

    // AbortSignal.timeout polyfill
    if (!AbortSignal.timeout) {
      AbortSignal.timeout = function(ms) {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), ms);
        return controller.signal;
      };
    }

    // Global variables - declare once at the top
    let previousUnreadCount = 0;
    let previousPendingPatients = 0;
    let previousPendingReferrals = 0;
    let isAddingPatient = false;
    let isApprovingPatient = false;
  </script>
  <script src="/admin-i18n.js"></script>
  <style>
    :root {
      --bg:#111827;
      --card:#1f2937;
      --b:#374151;
      --p:#2563eb;
      --g:#16a34a;
      --r:#dc2626;
      --y:#f59e0b;
      --muted:#a7b2c8;
      --link:#6aa6ff;
    }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#e6eaf2; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    header{ margin-bottom:20px; border-bottom:1px solid var(--b); padding-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px; }
    h1{ font-size:24px; margin:0 0 20px; font-weight:700; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--b);
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navbar-logo img {
      height: 32px;
      width: auto;
    }
    .navbar-logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--p);
      display: none; /* Hide text, show logo only */
    }
    .navbar-clinic-name {
      font-size: 16px;
      color: var(--muted);
      font-weight: 600;
    }
    .navbar-center {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
      justify-content: center;
    }
    .navbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .nav-link {
      color: var(--muted);
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      position: relative;
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: #e6eaf2;
      background: rgba(55, 65, 81, 0.3);
    }
    .nav-link.active {
      color: #fff;
      background: var(--p);
      font-weight: 600;
    }
    .nav-link.secondary {
      color: var(--muted);
      padding: 6px 10px;
      font-size: 13px;
    }
    .nav-link.secondary:hover {
      color: #e6eaf2;
      background: rgba(55, 65, 81, 0.2);
    }
    .lang-toggle {
      display: flex;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .lang-toggle span {
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .lang-toggle span.active {
      color: #fff;
      background: rgba(37, 99, 235, 0.3);
    }
    .nav-badge{
      position:absolute;
      top:-4px;
      right:-4px;
      background:var(--r);
      color:#fff;
      border-radius:10px;
      min-width:18px;
      height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:700;
      padding:0 4px;
      border:2px solid var(--bg);
    }

    .card{ background:var(--card); border:0.5px solid rgba(55, 65, 81, 0.5); border-radius:16px; padding:24px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.05); }
    .toolbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .toolbar-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolbar-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, select{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--b);
      background:#1f2937;
      color:#e6eaf2;
      font-size:14px;
      min-width:240px;
    }
    input::placeholder{ color:#94a3b8; }

    /* Mini Card Grid Layout */
    .patients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .patient-card {
      background: var(--card);
      border: 0.5px solid rgba(55, 65, 81, 0.5);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s;
      cursor: pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .patient-card:hover {
      border-color: #3b82f6;
      background: #0b1220;
    }
    .patient-card.selected {
      outline: 2px solid #2563eb;
      outline-offset: -2px;
      background: #0b1220;
      border-color: #2563eb;
    }
    .patient-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .patient-name {
      font-weight: 700;
      font-size: 16px;
      color: #ffffff;
      margin: 0;
      flex: 1;
    }
    .clinic-code-badge {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #93c5fd;
      margin-left: 8px;
    }
    .patient-meta {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .progress-section {
      margin-bottom: 12px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .progress-bar-container {
      height: 8px;
      background: #1f2937;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .progress-bar.good { background: linear-gradient(90deg, #16a34a, #22c55e); }
    .progress-bar.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .progress-bar.danger { background: linear-gradient(90deg, #dc2626, #ef4444); }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .card-actions button {
      flex: 1;
      min-width: 0;
      font-size: 12px;
      padding: 8px 12px;
    }

    code{ background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2937; color:#e6eaf2; }

    .status{ display:inline-block; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid #334155; text-transform:uppercase; }
    .status.PENDING{ background:#0b1220; color:#fef3c7; border-color:#92400e; }
    .status.APPROVED{ background:#064e3b; color:#6ee7b7; border-color:#059669; }

    button{ padding:8px 14px; border-radius:10px; border:1px solid transparent; cursor:pointer; font-size:13px; font-weight:800; transition:opacity 0.2s; }
    button:hover{ opacity:0.92; }
    button:disabled{ opacity:0.5; cursor:not-allowed; }
    .btn-approve{ background:var(--g); color:#fff; }
    /* Primary: Treatment (most important) */
    .btn-treatment{ background:var(--p); color:#fff; border-color:var(--p); }
    /* Secondary: Chat (secondary importance) */
    .btn-chat{ background:transparent; border-color:#334155; color:#e6eaf2; }
    .btn-chat:hover{ background:#1f2937; border-color:#4b5563; }
    /* Ghost: Travel / Health (tertiary, less visual weight) */
    .btn-travel, .btn-health{ background:transparent; border-color:#334155; color:var(--muted); }
    .btn-travel:hover, .btn-health:hover{ background:#1f2937; border-color:#4b5563; color:#e6eaf2; }
    .btn-ghost{ background:transparent; border-color:#334155; color:#e6eaf2; }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .loading{ text-align:center; padding:40px; color:var(--muted); }
    .error{ background:#7f1d1d; border:1px solid #dc2626; color:#fca5a5; padding:12px; border-radius:10px; margin-bottom:16px; }
    .token-info{ background:#0b1220; border:1px solid #334155; padding:12px; border-radius:10px; margin-bottom:16px; font-size:13px; color:#e6eaf2; }

    .selected-bar{
      position:sticky;
      top:0;
      z-index:5;
      background:rgba(2,6,23,0.92);
      backdrop-filter: blur(6px);
      border:1px solid #334155;
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
      display:none;
    }
    .selected-title{ font-weight:900; }
    .selected-meta{ color:var(--muted); font-size:13px; margin-top:2px; }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: var(--card);
      border: 1px solid var(--b);
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--b);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #e6eaf2;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: var(--b);
      color: #e6eaf2;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--b);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #e6eaf2;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--b);
      border-radius: 6px;
      background: var(--bg);
      color: #e6eaf2;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--p);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .btn-primary {
      background: var(--g);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      background: #15803d;
      transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 95%;
        margin: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üë• Clinifly Admin ‚Äì Patients</h1>
      <div id="usageBadge" style="display:none; padding:6px 10px; border:1px solid #334155; border-radius:999px; background:#0b1220; color:#e6eaf2; font-size:12px; font-weight:800; margin-top:12px;"></div>
    </header>

    <nav class="navbar">
      <div class="navbar-left">
        <div class="navbar-logo">
          <img src="/logo.svg" alt="Clinifly" />
          <span class="navbar-logo-text">Clinifly</span>
    </div>
        <div class="navbar-clinic-name" id="navbarClinicName">Clinic</div>
      </div>
      <div class="navbar-center">
        <a href="/admin-dashboard.html" class="nav-link" data-i18n="dashboard.nav.dashboard">Dashboard</a>
        <a href="/admin-patients.html" class="nav-link active" id="patientsNavLink">
          <span data-i18n="dashboard.nav.patients">Patients</span>
          <span id="patientsBadge" class="nav-badge" style="display:none;"></span>
        </a>
        <a href="/admin-doctor-applications-v2.html" class="nav-link" id="doctorApplicationsNavLink">
          <span>Doctor Applications</span>
          <span id="doctorApplicationsBadge" class="nav-badge" style="display:none;"></span>
        </a>
        <a href="/admin-chat.html" class="nav-link" id="chatNavLink">
          <span data-i18n="dashboard.nav.chat">Chat</span>
          <span id="chatBadge" class="nav-badge" style="display:none;"></span>
        </a>
      </div>
      <div class="navbar-right">
        <a href="/admin-settings.html" class="nav-link secondary" data-i18n="dashboard.nav.settings">Clinic Settings</a>
        <div class="lang-toggle">
          <span id="lang-tr" onclick="if(window.onLanguageChange) window.onLanguageChange('tr')" class="active">TR</span>
          <span>|</span>
          <span id="lang-en" onclick="if(window.onLanguageChange) window.onLanguageChange('en')">EN</span>
        </div>
        <a href="#" onclick="logout(); return false;" class="nav-link secondary" data-i18n="dashboard.nav.logout" style="cursor: pointer;">Logout</a>
    </div>
    </nav>

    <div id="tokenInfo" class="token-info" style="display:none;" data-i18n="patients.errors.noToken"></div>

    <div id="errorMsg" class="error" style="display:none;"></div>

    <div id="selectedBar" class="selected-bar">
      <div class="toolbar">
        <div>
          <div class="selected-title" id="selectedTitle"></div>
          <div class="selected-meta" id="selectedMeta"></div>
        </div>
        <div class="actions">
          <button class="btn-travel" onclick="openTravel(getSelectedPatientId())" data-i18n="patients.travel"></button>
          <button class="btn-health" onclick="openHealth(getSelectedPatientId())" data-i18n="patients.health"></button>
          <button class="btn-chat" onclick="openChat(getSelectedPatientId())" data-i18n="patients.chat"></button>
          <button class="btn-ghost" onclick="copySelectedPatientId()" data-i18n="patients.copyId"></button>
          <button class="btn-ghost" onclick="clearSelectedPatient()" data-i18n="patients.clear"></button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="toolbar" style="margin-bottom:12px;">
        <div class="toolbar-left">
          <h2 style="margin:0; font-size:18px;" data-i18n="patients.registeredPatients"></h2>
          <input id="searchInput" type="search" data-i18n-placeholder="patients.searchPlaceholder" />
          <select id="statusFilter" style="min-width:180px;">
            <option value="" data-i18n="patients.filterAll"></option>
            <option value="PENDING" data-i18n="patients.status.PENDING">PENDING</option>
            <option value="APPROVED" data-i18n="patients.status.APPROVED">APPROVED</option>
          </select>
        </div>
        <div class="toolbar-right">
          <button class="btn-primary" onclick="showAddPatientModal()" style="background:var(--g); color:#fff; margin-right:8px;" data-i18n="patients.addPatient">‚ûï Add Patient</button>
          <button class="btn-ghost" onclick="clearFilters()" data-i18n="patients.clearFilters"></button>
          <button onclick="loadPatients()" style="background:var(--p); color:#fff;" data-i18n="patients.refresh"></button>
        </div>
      </div>

      <div id="loading" class="loading" data-i18n="patients.loading"></div>
      <div id="patientsGrid" class="patients-grid" style="display:none;"></div>
    </div>
  </div>

  <!-- Add Patient Modal -->
  <div id="addPatientModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 data-i18n="patients.addPatientTitle">Add New Patient</h3>
        <button class="modal-close" onclick="hideAddPatientModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="addPatientForm">
          <div class="form-row">
            <div class="form-group">
              <label for="patientFirstName" data-i18n="patients.firstName">First Name *</label>
              <input type="text" id="patientFirstName" required>
            </div>
            <div class="form-group">
              <label for="patientLastName" data-i18n="patients.lastName">Last Name *</label>
              <input type="text" id="patientLastName" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="patientEmail" data-i18n="patients.email">Email</label>
              <input type="email" id="patientEmail">
            </div>
            <div class="form-group">
              <label for="patientPhone" data-i18n="patients.phone">Phone</label>
              <input type="tel" id="patientPhone">
            </div>
          </div>
          
          <div class="form-group">
            <label for="patientDateOfBirth" data-i18n="patients.dateOfBirth">Date of Birth</label>
            <input type="date" id="patientDateOfBirth">
          </div>
          
          <div class="form-group">
            <label for="patientAddress" data-i18n="patients.address">Address</label>
            <textarea id="patientAddress" rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label for="patientNotes" data-i18n="patients.notes">Notes</label>
            <textarea id="patientNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-ghost" onclick="hideAddPatientModal()" data-i18n="patients.cancel">Cancel</button>
        <button type="button" id="addPatientBtn" class="btn-primary" data-i18n="patients.add">Add Patient</button>
      </div>
    </div>
  </div>

  <script>
    // Nav: if a patient is selected, make top-nav Travel link carry patientId.
    (function bindNavTravelLink() {
      try {
        const pid = String(localStorage.getItem('selected_patient_id') || '').trim();
        if (!pid) return;
        const a = document.querySelector('.nav a[href="/admin-travel.html"]');
        if (a) a.href = `/admin-travel.html?patientId=${encodeURIComponent(pid)}`;
      } catch {}
    })();

    const API_BASE =
      window.location.hostname === "localhost"
        ? "http://localhost:5050"
        : "https://cliniflow-backend-dg8a.onrender.com";
    let ALL_PATIENTS = [];
    let CLINIC_PLAN = "";
    let CLINIC_MAX_PATIENTS = null;
    
    function getAdminToken() {
      return localStorage.getItem('adminToken') || '';
    }
    function logout() {
      try {
        localStorage.removeItem("adminToken");
        console.log("[LOGOUT] Admin token cleared");
      } catch (e) {
        console.error("[LOGOUT] Error clearing token:", e);
      }
      window.location.href = "/admin-login.html";
    }

    function getSelectedPatientId() {
      return localStorage.getItem('selected_patient_id') || '';
    }

    function setSelectedPatient(patientId, name) {
      if (!patientId) return;
      localStorage.setItem('selected_patient_id', patientId);
      if (name) localStorage.setItem('selected_patient_name', name);
      renderSelectedBar();
      // refresh row highlighting
      applyFilters();
    }

    function clearSelectedPatient() {
      localStorage.removeItem('selected_patient_id');
      localStorage.removeItem('selected_patient_name');
      renderSelectedBar();
      applyFilters();
    }

    function renderSelectedBar() {
      const bar = document.getElementById('selectedBar');
      const pid = getSelectedPatientId();
      const name = localStorage.getItem('selected_patient_name') || '';
      if (!pid) {
        bar.style.display = 'none';
        return;
      }
      bar.style.display = 'block';
      if (window.i18n) {
        document.getElementById('selectedTitle').textContent = window.i18n.t('patients.selectedPatient', { name: name || '‚Äî' });
        document.getElementById('selectedMeta').textContent = window.i18n.t('patients.patientId', { id: pid });
      } else {
      document.getElementById('selectedTitle').textContent = `Se√ßili Hasta: ${name || '‚Äî'}`;
      document.getElementById('selectedMeta').textContent = `Patient ID: ${pid}`;
      }
    }

    async function copySelectedPatientId() {
      const pid = getSelectedPatientId();
      if (!pid) return;
      try {
        await navigator.clipboard.writeText(pid);
      } catch {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = pid;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
      const message = window.i18n ? window.i18n.t('patients.copyIdSuccess') : '‚úÖ Patient ID kopyalandƒ±';
      alert(message);
    }

    function normalizePlanValue(planValue) {
      const raw = String(planValue || "").trim().toUpperCase();
      if (raw === "PROFESSIONAL") return "PRO";
      if (raw === "FREE" || raw === "BASIC" || raw === "PRO") return raw;
      return "FREE";
    }

    function getMaxPatients(plan, explicitMax) {
      if (explicitMax !== null && explicitMax !== undefined && explicitMax !== "") {
        const num = Number(explicitMax);
        return Number.isFinite(num) ? num : explicitMax;
      }
      if (plan === "FREE") return 3;
      if (plan === "BASIC") return 15;
      if (plan === "PRO") return null;
      return 3;
    }

    function renderUsageBadge() {
      const el = document.getElementById("usageBadge");
      if (!el) return;
      const plan = normalizePlanValue(CLINIC_PLAN || "FREE");
      const maxPatients = getMaxPatients(plan, CLINIC_MAX_PATIENTS);
      const used = ALL_PATIENTS.length;
      if (maxPatients === null || maxPatients === undefined) {
        el.textContent = `Plan: ${plan} ‚Ä¢ ${used} / ‚àû patients`;
      } else {
        el.textContent = `Plan: ${plan} ‚Ä¢ ${used} / ${maxPatients} patients`;
      }
      el.style.display = "inline-flex";
      if (maxPatients !== null && maxPatients !== undefined && used >= maxPatients) {
        el.style.borderColor = "#dc2626";
        el.style.color = "#fecaca";
      } else {
        el.style.borderColor = "#334155";
        el.style.color = "#e6eaf2";
      }
    }

    async function loadClinicBadge() {
      const token = getAdminToken();
      if (!token) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/clinic`, {
          headers: { Authorization: `Bearer ${token}`, 'Accept': 'application/json' },
        });
        if (!res.ok) return;
        const clinic = await res.json();
        const name = clinic.branding?.clinicName || clinic.name || "Clinic";
        
        // Update navbar clinic name
        const navbarClinicName = document.getElementById("navbarClinicName");
        if (navbarClinicName) {
          navbarClinicName.textContent = name;
        }
        
        // Also update clinic badge if exists
        const code = clinic.clinicCode || clinic.code || "";
        const badge = document.getElementById("clinicBadge");
        if (badge) {
          badge.textContent = code ? `${code} ¬∑ ${name}` : name;
        badge.style.display = "inline-flex";
        }
        
        // Update clinic plan and max patients if needed
        if (clinic.plan) CLINIC_PLAN = clinic.plan;
        if (clinic.subscriptionPlan) CLINIC_PLAN = clinic.subscriptionPlan;
        if (clinic.max_patients !== undefined) CLINIC_MAX_PATIENTS = clinic.max_patients;
        if (clinic.maxPatients !== undefined) CLINIC_MAX_PATIENTS = clinic.maxPatients;
        
        renderUsageBadge();
      } catch (error) {
        console.error('Failed to load clinic name:', error);
        const navbarClinicName = document.getElementById("navbarClinicName");
        if (navbarClinicName) {
          navbarClinicName.textContent = "Clinic";
        }
      }
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function clearFilters() {
      const s = document.getElementById('searchInput');
      const f = document.getElementById('statusFilter');
      if (s) s.value = '';
      if (f) f.value = '';
      applyFilters();
    }

    function applyFilters() {
      const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
      const status = (document.getElementById('statusFilter')?.value || '').trim();

      const filtered = ALL_PATIENTS.filter((p) => {
        const pid = String(p.patientId || p.patient_id || '').toLowerCase();
        const name = String(p.fullName || p.name || '').toLowerCase();
        const phone = String(p.phone || '').toLowerCase();
        const clinic = String(p.clinicCode || p.clinic_code || '').toLowerCase();
        const st = String(p.status || 'PENDING');

        const qok = !q || pid.includes(q) || name.includes(q) || phone.includes(q) || clinic.includes(q);
        const sok = !status || st === status;
        return qok && sok;
      });

      renderPatients(filtered);
    }

    async function loadPatients() {
      const token = getAdminToken();
      if (!token) {
        document.getElementById('tokenInfo').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        return;
      }
      document.getElementById('tokenInfo').style.display = 'none';

      const loadingEl = document.getElementById('loading');
      const patientsGrid = document.getElementById('patientsGrid');

      loadingEl.style.display = 'block';
      patientsGrid.style.display = 'none';

      try {
        const res = await adminFetch(`${API_BASE}/api/admin/patients`);

        if (!res.ok) {
          if (res.status === 401) {
            const message = window.i18n ? window.i18n.t('patients.errors.unauthorized') : '‚ùå Yetkilendirme hatasƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.';
            showError(message);
            return;
          }
          throw new Error(`HTTP ${res.status}`);
        }

        const json = await res.json();
        if (!json.ok) {
          throw new Error(json.error || 'Bilinmeyen hata');
        }

        const patients = Array.isArray(json.patients) ? json.patients : (Array.isArray(json.list) ? json.list : []);
        console.log('[PATIENTS] API Response:', patients.slice(0, 3)); // Debug first 3 patients
        ALL_PATIENTS = patients;
        applyFilters();
        renderUsageBadge();
        
        loadingEl.style.display = 'none';
        patientsGrid.style.display = 'grid';
      } catch (error) {
        console.error('Load patients error:', error);
        const message = window.i18n ? window.i18n.t('patients.errors.loadFailed', { error: error.message }) : '‚ùå Hasta listesi y√ºklenemedi: ' + error.message;
        showError(message);
        loadingEl.style.display = 'none';
      }
    }

    // Helper function to get translation
    function t(key, params = {}) {
      if (window.i18n && window.i18n.t) {
        return window.i18n.t(key, params);
      }
      // Fallback to Turkish defaults (if i18n not loaded yet)
      const fallbacks = {
        'patients.before': '√ñnce',
        'patients.after': 'Sonra',
        'patients.treatment': 'Tedavi',
        'patients.chat': 'Chat',
        'patients.travel': 'Seyahat',
        'patients.health': 'Saƒülƒ±k',
        'patients.approve': 'Onayla',
        'patients.noResults': 'Sonu√ß yok'
      };
      return fallbacks[key] || key;
    }

    function renderPatients(patients) {
      const grid = document.getElementById('patientsGrid');
      if (patients.length === 0) {
        const noResultsText = t('patients.noResults');
        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#a7b2c8;">${noResultsText}</div>`;
        return;
      }

      function getProgressClass(score) {
        if (score === null || score === undefined) return '';
        if (score >= 80) return 'good';
        if (score >= 60) return 'warning';
        if (score >= 40) return 'danger';
        return 'danger';
      }
      
      function formatScore(score) {
        if (score === null || score === undefined) return 0;
        return Math.round(score);
      }

      grid.innerHTML = patients.map(p => {
        const status = p.status || 'PENDING';
        const patientId = (p.patientId || p.patient_id || '').toString();
        
        // Enhanced name resolution with multiple fallbacks
        let displayName = (p.fullName || p.name || '').toString();
        if (!displayName || displayName === '-' || displayName === 'null' || displayName === 'undefined') {
          // Try to construct from first_name + last_name
          if (p.first_name && p.last_name) {
            displayName = `${p.first_name} ${p.last_name}`;
          } else if (p.firstName && p.lastName) {
            displayName = `${p.firstName} ${p.lastName}`;
          } else {
            // Final fallback to patient ID but make it more readable
            displayName = `Patient ${patientId.slice(-8)}`; // Show last 8 chars only
          }
        }
        
        const isSelected = getSelectedPatientId() && getSelectedPatientId() === patientId;
        const createdAt = p.createdAt || p.created_at || '-';
        const currentLang = window.i18n ? window.i18n.getLang() : 'tr';
        const locale = currentLang === 'en' ? 'en-US' : 'tr-TR';
        const dateStr = createdAt !== '-' ? new Date(createdAt).toLocaleDateString(locale) : '-';
        const beforeScore = p.beforeScore !== undefined ? p.beforeScore : null;
        const afterScore = p.afterScore !== undefined ? p.afterScore : null;
        const beforePercent = formatScore(beforeScore);
        const afterPercent = formatScore(afterScore);
        const clinicCode = p.clinicCode || p.clinic_code || '';
        
        return `
          <div class="patient-card ${isSelected ? 'selected' : ''}" onclick="setSelectedPatient('${escapeHtml(patientId)}', '${escapeHtml(displayName)}')">
            <div class="patient-card-header">
              <h3 class="patient-name">
                <a href="/admin-patient-detail.html?patientId=${escapeHtml(patientId)}" style="color: inherit; text-decoration: none;" onclick="event.stopPropagation()">
                  ${escapeHtml(displayName)}${clinicCode ? `<span class="clinic-code-badge">${escapeHtml(clinicCode)}</span>` : ''}
                </a>
              </h3>
              ${status === 'PENDING' ? `<span class="status ${status}">${window.i18n ? window.i18n.t('patients.status.PENDING') : 'PENDING'}</span>` : ''}
              ${status === 'APPROVED' ? `<span class="status ${status}">${window.i18n ? window.i18n.t('patients.status.APPROVED') : 'APPROVED'}</span>` : ''}
              </div>
            
            <div class="patient-meta">
              ${p.phone ? `<div>üìû ${escapeHtml(p.phone)}</div>` : ''}
              <div style="margin-top:4px; font-size:11px; color:#64748b;">
                <code style="font-size:11px;">${escapeHtml(patientId)}</code> ‚Ä¢ ${dateStr}
              </div>
            </div>
            
            ${(beforeScore !== null || afterScore !== null) ? `
            <div class="progress-section">
              ${beforeScore !== null ? `
              <div class="progress-label">
                <span>${window.i18n ? window.i18n.t('patients.before') : t('patients.before')}</span>
                <span>${beforePercent}%</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar ${getProgressClass(beforeScore)}" style="width: ${beforePercent}%"></div>
              </div>
              ` : ''}
              
              ${afterScore !== null ? `
              <div class="progress-label" style="margin-top:8px;">
                <span>${window.i18n ? window.i18n.t('patients.after') : t('patients.after')}</span>
                <span>${afterPercent}%</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar ${getProgressClass(afterScore)}" style="width: ${afterPercent}%"></div>
              </div>
              ` : ''}
            </div>
            ` : ''}
            
            <div class="card-actions" onclick="event.stopPropagation()">
              ${status === 'PENDING' ? `<button class="btn-approve" onclick="approvePatient('${escapeHtml(patientId)}')">${window.i18n ? window.i18n.t('patients.approve') : t('patients.approve')}</button>` : ''}
              <button class="btn-chat" onclick="openChat('${escapeHtml(patientId)}')">${window.i18n ? window.i18n.t('patients.chat') : t('patients.chat')}</button>
              <button class="btn-travel" onclick="openTravel('${escapeHtml(patientId)}')">${window.i18n ? window.i18n.t('patients.travel') : t('patients.travel')}</button>
              <button class="btn-health" onclick="openHealth('${escapeHtml(patientId)}')">${window.i18n ? window.i18n.t('patients.health') : t('patients.health')}</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function approvePatient(patientId) {
      // Prevent double submission
      if (isAddingPatient) {
        console.log('APPROVE PATIENT - ADD PATIENT IN PROGRESS, IGNORING');
        return;
      }

      if (isApprovingPatient) {
        console.log('APPROVE PATIENT ALREADY IN PROGRESS - IGNORING');
        return;
      }

      isApprovingPatient = true;
      console.log('APPROVE PATIENT STARTED');

      const token = getAdminToken();
      if (!token) {
        const message = window.i18n ? window.i18n.t('patients.errors.noToken') : '‚ùå Admin token bulunamadƒ±';
        showError(message);
        isApprovingPatient = false;
        return;
      }

      // Check patient limit before approval
      const limitCheck = await checkPatientLimit();
      if (!limitCheck.canApprove) {
        showPatientLimitModal(limitCheck);
        isApprovingPatient = false;
        return;
      }

      const confirmMessage = window.i18n ? window.i18n.t('patients.approveConfirm', { patientId }) : `Hastayƒ± onaylamak istediƒüinize emin misiniz? (${patientId})`;
      if (!confirm(confirmMessage)) {
        isApprovingPatient = false;
        return;
      }

      try {
        // Disable approve button
        const approveBtn = document.querySelector(`[onclick="approvePatient('${patientId}')"]`);
        if (approveBtn) {
          approveBtn.disabled = true;
          approveBtn.textContent = 'Approving...';
        }

        const res = await adminFetch(`${API_BASE}/api/admin/approve`, {
          method: 'POST',
          body: JSON.stringify({ patientId })
        });

        const json = await res.json();
        if (!res.ok || !json.ok) {
          throw new Error(json.error || 'Onaylama ba≈üarƒ±sƒ±z');
        }

        const successMessage = window.i18n ? window.i18n.t('patients.approveSuccess') : '‚úÖ Hasta onaylandƒ±';
        alert(successMessage);
        loadPatients(); // Refresh patient list after approval
      } catch (error) {
        console.error('Approve error:', error);
        const errorMessage = window.i18n ? window.i18n.t('patients.errors.approveFailed') : '‚ùå Onaylama ba≈üarƒ±sƒ±z';
        showError(errorMessage);
      } finally {
        // Always reset submission state
        isApprovingPatient = false;
        
        // Re-enable approve button
        const approveBtn = document.querySelector(`[onclick="approvePatient('${patientId}')"]`);
        if (approveBtn) {
          approveBtn.disabled = false;
          approveBtn.textContent = 'Approve';
        }
        
        console.log('APPROVE PATIENT COMPLETED - STATE RESET');
      }
    }

    async function checkPatientLimit() {
      const token = getAdminToken();
      if (!token) {
        return { canApprove: false, error: 'No token' };
      }

      try {
        // Get clinic info to check plan
        const clinicRes = await fetch(`${API_BASE}/api/admin/clinic`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });

        if (!clinicRes.ok) {
          return { canApprove: true }; // If we can't check, allow approval
        }

        const clinic = await clinicRes.json();
        const plan = clinic.subscriptionPlan || 'FREE';
        
        // Get current approved patients count
        const patientsRes = await adminFetch(`${API_BASE}/api/admin/patients?status=APPROVED`);

        if (!patientsRes.ok) {
          return { canApprove: true }; // If we can't check, allow approval
        }

        const patients = await patientsRes.json();
        const currentApproved = Array.isArray(patients) ? patients.length : 0;
        
        // Define limits
        const limits = {
          'FREE': 5,
          'BASIC': 15,
          'PRO': Infinity
        };

        const limit = limits[plan] || 5;
        const canApprove = currentApproved < limit;

        return {
          canApprove,
          current: currentApproved,
          limit,
          plan,
          clinic
        };
      } catch (error) {
        console.error('Limit check error:', error);
        return { canApprove: true }; // If check fails, allow approval
      }
    }

    function showPatientLimitModal(limitCheck) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      const content = document.createElement('div');
      content.style.cssText = `
        background: var(--card, #1f2937);
        border: 1px solid var(--border, #374151);
        border-radius: 16px;
        padding: 32px;
        max-width: 480px;
        width: 90%;
        text-align: center;
      `;

      const title = window.i18n ? window.i18n.t('patients.limits.title') : 'Aktif Hasta Limiti';
      const message = window.i18n ? 
        window.i18n.t('patients.limits.message', { current: limitCheck.current, limit: limitCheck.limit }) :
        `Mevcut planƒ±nƒ±zda ${limitCheck.current}/${limitCheck.limit} aktif hasta bulunuyor.`;
      const upgradeMessage = window.i18n ? window.i18n.t('patients.limits.upgradeMessage') : 'Yeni hasta eklemek i√ßin planƒ±nƒ±zƒ± y√ºkseltebilirsiniz.';
      const upgradeButton = window.i18n ? window.i18n.t('patients.limits.upgradeButton') : 'Planƒ± Y√ºkselt';
      const continueButton = window.i18n ? window.i18n.t('patients.limits.continueButton') : 'Mevcut Hastalarla Devam Et';

      content.innerHTML = `
        <h2 style="margin: 0 0 16px 0; color: var(--warning, #f59e0b); font-size: 24px;">‚ö†Ô∏è ${title}</h2>
        <p style="margin: 0 0 8px 0; color: var(--text, #e6eaf2); font-size: 16px;">${message}</p>
        <p style="margin: 0 0 24px 0; color: var(--muted, #a7b2c8); font-size: 14px;">${upgradeMessage}</p>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button onclick="window.open('/pricing.html', '_blank')" style="
            background: var(--primary, #2563eb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">${upgradeButton}</button>
          <button onclick="this.closest('div[style*=fixed]').remove()" style="
            background: transparent;
            color: var(--muted, #a7b2c8);
            border: 1px solid var(--border, #374151);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">${continueButton}</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function getPatientNameById(patientId) {
      const found = ALL_PATIENTS.find(
        (p) => String(p.patientId || p.patient_id || "") === String(patientId || "")
      );
      return (found?.fullName || found?.name || "").toString();
    }

    function openTravel(patientId) {
      setSelectedPatient(patientId, getPatientNameById(patientId));
      window.location.href = `/admin-travel.html?patientId=${encodeURIComponent(patientId)}`;
    }

    function openChat(patientId) {
      setSelectedPatient(patientId, getPatientNameById(patientId));
      window.location.href = `/admin-chat.html?patientId=${encodeURIComponent(patientId)}`;
    }

    function openHealth(patientId) {
      setSelectedPatient(patientId, getPatientNameById(patientId));
      window.location.href = `/admin-health.html?patientId=${encodeURIComponent(patientId)}`;
    }

    // Add Patient Modal Functions
    function showAddPatientModal() {
      document.getElementById('addPatientModal').style.display = 'flex';
      document.getElementById('addPatientForm').reset();
    }

    function hideAddPatientModal() {
      document.getElementById('addPatientModal').style.display = 'none';
    }

    async function addPatient() {
      // Prevent double submission
      if (isAddingPatient) {
        console.log('ADD PATIENT ALREADY IN PROGRESS - IGNORING');
        return;
      }

      isAddingPatient = true;
      console.log('ADD PATIENT STARTED');

      try {
        const firstName = document.getElementById('patientFirstName').value.trim();
        const lastName = document.getElementById('patientLastName').value.trim();

        if (!firstName || !lastName) {
          alert('First name and last name required');
          isAddingPatient = false;
          return;
        }

        const token = getAdminToken();
        if (!token) {
          alert('Authentication required');
          isAddingPatient = false;
          return;
        }

        // Disable add button
        const addBtn = document.getElementById('addPatientBtn');
        if (addBtn) {
          addBtn.disabled = true;
          addBtn.textContent = 'Adding...';
        }

        const response = await fetch(`${API_BASE}/api/admin/patients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ firstName, lastName })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to add patient');
        }

        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || 'Failed to add patient');
        }

        hideAddPatientModal();
        loadPatients(); // Refresh patient list
        
        // Show success message
        const successMsg = window.i18n ? 
          window.i18n.t('patients.addSuccess') : 
          'Patient added successfully!';
        alert(successMsg);
        
      } catch (error) {
        console.error('[PATIENTS] Add error:', error);
        const errorMsg = window.i18n ? 
          window.i18n.t('patients.addError') : 
          'Failed to add patient: ' + error.message;
        alert(errorMsg);
      } finally {
        // Always reset submission state
        isAddingPatient = false;
        
        // Re-enable add button
        const addBtn = document.getElementById('addPatientBtn');
        if (addBtn) {
          addBtn.disabled = false;
          addBtn.textContent = 'Add Patient';
        }
        
        console.log('ADD PATIENT COMPLETED - STATE RESET');
      }
    }

    // Badge loading functions
    const API =
      window.location.hostname === "localhost"
        ? "http://localhost:5050"
        : "https://cliniflow-backend-dg8a.onrender.com";
    function adminHeaders(extra = {}) {
      const token = getAdminToken();
      return {
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        ...extra,
      };
    }

    // ‚úÖ adminFetch wrapper with automatic Authorization header
    async function adminFetch(url, options = {}) {
      const token = getAdminToken();
      if (!token) {
        throw new Error('Admin token required');
      }

      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          ...options.headers
        }
      };

      const mergedOptions = {
        ...defaultOptions,
        ...options,
        headers: defaultOptions.headers
      };

      return fetch(url, mergedOptions);
    }

    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.warn("Could not play notification sound:", e);
      }
    }

    // Optimized unread count loading (single request) - TEMPORARILY DISABLED
    async function loadUnreadCountOptimized() {
      // Temporarily disabled to isolate performance issues
      return;
      
      const token = getAdminToken();
      if (!token) return;
      try {
        const unreadRes = await fetch(`${API}/api/admin/unread-count`, {
          headers: adminHeaders({ Accept: "application/json" }),
        });
        if (!unreadRes.ok) return;
        const unreadData = await unreadRes.json();
        if (!unreadData.ok) return;
        
        const totalUnread = unreadData.unreadCount || 0;
        
        if (totalUnread > previousUnreadCount && previousUnreadCount > 0) {
          playNotificationSound();
        }
        previousUnreadCount = totalUnread;
        const badgeEl = document.getElementById("chatBadge");
        if (badgeEl) {
          if (totalUnread > 0) {
            badgeEl.textContent = totalUnread > 99 ? "99+" : String(totalUnread);
            badgeEl.style.display = "flex";
          } else {
            badgeEl.style.display = "none";
          }
        }
      } catch (error) {
        console.error("Load unread count optimized error:", error);
      }
    }

    async function loadUnreadMessageCount() {
      const token = getAdminToken();
      if (!token) return;
      try {
        let lastSeenTimestamp = 0;
        try {
          const stored = localStorage.getItem('chat_last_seen_timestamp');
          if (stored) lastSeenTimestamp = parseInt(stored, 10) || 0;
        } catch (e) {}
        const patientsRes = await fetch(`${API}/api/admin/patients`, {
          headers: adminHeaders({ Accept: "application/json" }),
        });
        if (!patientsRes.ok) return;
        const patientsData = await patientsRes.json();
        if (!patientsData.ok) return;
        const patients = Array.isArray(patientsData.patients) ? patientsData.patients : [];
        let totalUnread = 0;
        for (const patient of patients) {
          const patientId = patient.patientId || patient.id;
          if (!patientId) continue;
          try {
            const messagesRes = await fetch(`${API}/api/admin/patient/${encodeURIComponent(patientId)}/messages`, {
              headers: adminHeaders({ Accept: "application/json" }),
            });
            if (!messagesRes.ok) continue;
            const messagesData = await messagesRes.json();
            if (!messagesData.ok) continue;
            const messages = Array.isArray(messagesData.messages) ? messagesData.messages : [];
            const unread = messages.filter((m) => {
              if (m.from_patient !== true) return false;
              if (m.created_at) {
                const msgTimestamp = new Date(m.created_at).getTime();
                return msgTimestamp > lastSeenTimestamp;
              }
              return true;
            }).length;
            totalUnread += unread;
          } catch (e) { continue; }
        }
        if (totalUnread > previousUnreadCount && previousUnreadCount > 0) {
          playNotificationSound();
        }
        previousUnreadCount = totalUnread;
        const badgeEl = document.getElementById("chatBadge");
        if (badgeEl) {
          if (totalUnread > 0) {
            badgeEl.textContent = totalUnread > 99 ? "99+" : String(totalUnread);
            badgeEl.style.display = "flex";
          } else {
            badgeEl.style.display = "none";
          }
        }
      } catch (error) {
        console.error("Load unread count error:", error);
      }
    }

    async function loadPendingPatientsCount() {
      const token = getAdminToken();
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/admin/patients`, {
          headers: adminHeaders({ Accept: "application/json" }),
          signal: AbortSignal.timeout(10000) // 10 second timeout
        });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.ok) return;
        const patients = Array.isArray(data.patients) ? data.patients : (Array.isArray(data.list) ? data.list : []);
        const pendingCount = patients.filter(p => (p.status || "PENDING") === "PENDING").length;
        if (pendingCount > previousPendingPatients && previousPendingPatients > 0) {
          playNotificationSound();
        }
        previousPendingPatients = pendingCount;
        const badgeEl = document.getElementById("patientsBadge");
        if (badgeEl) {
          if (pendingCount > 0) {
            badgeEl.textContent = pendingCount > 99 ? "99+" : String(pendingCount);
            badgeEl.style.display = "flex";
          } else {
            badgeEl.style.display = "none";
          }
        }
      } catch (error) {
        console.error("Load pending patients count error:", error);
      }
    }

    async function loadPendingReferralsCount() {
      const token = getAdminToken();
      if (!token) return;
      try {
        const res = await fetch(`${API}/api/admin/referrals?status=PENDING`, {
          headers: adminHeaders({ Accept: "application/json" }),
          signal: AbortSignal.timeout(10000) // 10 second timeout
        });
        if (!res.ok) return;
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];
        const pendingCount = items.length;
        if (pendingCount > previousPendingReferrals && previousPendingReferrals > 0) {
          playNotificationSound();
        }
        previousPendingReferrals = pendingCount;
        const badgeEl = document.getElementById("referralsBadge");
        if (badgeEl) {
          if (pendingCount > 0) {
            badgeEl.textContent = pendingCount > 99 ? "99+" : String(pendingCount);
            badgeEl.style.display = "flex";
          } else {
            badgeEl.style.display = "none";
          }
        }
      } catch (error) {
        console.error("Load pending referrals count error:", error);
      }
    }

    async function loadAllBadges() {
      // Temporarily disabled - only load patients badge
      return;
      
      await Promise.all([
        loadUnreadCountOptimized(),
        loadPendingPatientsCount(),
        loadPendingReferralsCount()
      ]);
    }

    // Language change handler
    window.onI18nUpdated = function(lang) {
      renderSelectedBar();
      applyFilters(); // Re-render patient cards with new language
      updateStatusFilterOptions(); // Update status filter options (includes PENDING/APPROVED)
      updateLangToggle();
      updateNavbar(); // Update navbar menu items
    };

    function updateNavbar() {
      if (!window.i18n) return;
      // Update navbar links - i18n.updatePage() handles data-i18n attributes
      // But we need to update nested spans manually
      const patientsNavLink = document.getElementById('patientsNavLink');
      if (patientsNavLink) {
        const span = patientsNavLink.querySelector('span[data-i18n]');
        if (span) {
          span.textContent = window.i18n.t('dashboard.nav.patients');
        }
      }
      const chatNavLink = document.getElementById('chatNavLink');
      if (chatNavLink) {
        const span = chatNavLink.querySelector('span[data-i18n]');
        if (span) {
          span.textContent = window.i18n.t('dashboard.nav.chat');
        }
      }
    }

    function updateStatusFilterOptions() {
      const filter = document.getElementById('statusFilter');
      if (filter && window.i18n) {
        const firstOption = filter.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = window.i18n.t('patients.filterAll');
        }
        const pendingOption = filter.querySelector('option[value="PENDING"]');
        if (pendingOption) {
          pendingOption.textContent = window.i18n.t('patients.status.PENDING');
        }
        const approvedOption = filter.querySelector('option[value="APPROVED"]');
        if (approvedOption) {
          approvedOption.textContent = window.i18n.t('patients.status.APPROVED');
        }
      }
    }

    function updateLangToggle() {
      if (!window.i18n) return;
      const langTr = document.getElementById('lang-tr');
      const langEn = document.getElementById('lang-en');
      const currentLang = window.i18n.getLang();
      if (langTr) {
        langTr.classList.toggle('active', currentLang === 'tr');
      }
      if (langEn) {
        langEn.classList.toggle('active', currentLang === 'en');
      }
    }

    // Load on page load
    window.addEventListener('load', () => {
      // Wait for i18n to be ready
      if (window.i18n) {
        updateLangToggle();
        updateStatusFilterOptions();
        window.i18n.updatePage();
        updateNavbar();
      }
      loadClinicBadge();
      renderSelectedBar();
      const s = document.getElementById('searchInput');
      const f = document.getElementById('statusFilter');
      if (s) s.addEventListener('input', () => applyFilters());
      if (f) f.addEventListener('change', () => applyFilters());
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof bindNavTravelLink === "function") {
        bindNavTravelLink();
      }
      
      // Load patients first (this manages its own loading state)
      loadPatients().then(() => {
        // After patients are loaded, load only patients badge
        loadPendingPatientsCount();
      }).catch(err => {
        console.error('Failed to load patients:', err);
        // Still load patients badge even if patients fail
        loadPendingPatientsCount();
      });
      
      // Add event listener for add patient button
      const addBtn = document.getElementById('addPatientBtn');
      if (addBtn) {
        addBtn.addEventListener('click', addPatient);
      }
    });

    // Auto-refresh badges every 30 seconds
    // setInterval(loadAllBadges, 30000);
  </script>
</body>
</html>

